<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhD Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafafa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 10px 0;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab:hover {
            color: #000;
        }

        .tab.active {
            border-bottom-color: #333;
            color: #000;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .milestone {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .milestone:hover {
            border-color: #999;
        }

        .milestone-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
        }

        .milestone-title {
            font-weight: 600;
            flex: 1;
        }

        .milestone.completed .milestone-title {
            text-decoration: line-through;
            color: #999;
        }

        .milestone-date {
            font-size: 13px;
            color: #666;
        }

        .milestone-date.overdue {
            color: #d32f2f;
        }

        .milestone-description {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
            padding-left: 32px;
        }

        .add-milestone {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #ccc;
            cursor: pointer;
            text-align: center;
            color: #666;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .add-milestone:hover {
            border-color: #999;
            color: #333;
        }

        .info-processor {
            background: white;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }

        textarea:focus {
            outline: none;
            border-color: #999;
        }

        button {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            background: #000;
        }

        .summary {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.8;
        }

        .summary h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
        }

        #loginScreen.hidden {
            display: none;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-container h1 {
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-container p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .oauth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .oauth-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .oauth-btn.github {
            border-color: #333;
            color: #333;
        }

        .oauth-btn.google {
            border-color: #ddd;
            color: #1f2937;
        }

        .oauth-btn.microsoft {
            border-color: #0078d4;
            color: #0078d4;
        }

        #mainContent {
            display: block;
        }

        #mainContent.hidden {
            display: none;
        }

        .logout-btn {
            background: #d32f2f;
            padding: 8px 16px;
            font-size: 13px;
        }

        .logout-btn:hover {
            background: #b71c1c;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #ccc;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: #333;
            height: 100%;
            transition: width 0.3s;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
        }

        .meeting-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }

        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .meeting-date-label {
            font-weight: 600;
            font-size: 15px;
        }

        .delete-meeting {
            color: #999;
            cursor: pointer;
            font-size: 13px;
        }

        .delete-meeting:hover {
            color: #d32f2f;
        }

        .action-list {
            margin-top: 10px;
        }

        .action-item {
            padding: 8px 0;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #f5f5f5;
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-item::before {
            content: "‚Üí ";
            color: #666;
            margin-right: 8px;
        }

        .no-meetings {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
        }

        .add-to-milestones {
            background: #f5f5f5;
            color: #333;
            font-size: 13px;
            padding: 6px 12px;
            margin-left: 10px;
        }

        .add-to-milestones:hover {
            background: #e0e0e0;
        }

        .attachments {
            margin-top: 12px;
            padding-left: 32px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 13px;
        }

        .attachment-link {
            color: #0066cc;
            text-decoration: none;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-link:hover {
            text-decoration: underline;
        }

        .remove-attachment {
            color: #999;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-attachment:hover {
            color: #d32f2f;
        }

        .add-attachment-btn {
            background: none;
            border: 1px solid #e0e0e0;
            color: #666;
            font-size: 12px;
            padding: 6px 12px;
            margin-left: 32px;
            margin-top: 8px;
        }

        .add-attachment-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .attachment-form {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-left: 32px;
        }

        .attachment-form.active {
            display: block;
        }

        .attachment-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .attachment-form-buttons {
            display: flex;
            gap: 8px;
        }

        .attachment-form button {
            font-size: 12px;
            padding: 6px 12px;
        }

        .milestone-notes {
            margin-top: 12px;
            padding-left: 32px;
        }

        .notes-display {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
            white-space: pre-wrap;
            margin-bottom: 8px;
        }

        .notes-form {
            display: none;
            margin-top: 8px;
        }

        .notes-form.active {
            display: block;
        }

        .notes-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 8px;
        }

        .notes-buttons {
            display: flex;
            gap: 8px;
        }

        .notes-buttons button {
            font-size: 12px;
            padding: 6px 12px;
        }

        .add-notes-btn {
            background: none;
            border: 1px solid #e0e0e0;
            color: #666;
            font-size: 12px;
            padding: 6px 12px;
            margin-left: 32px;
            margin-top: 8px;
        }

        .add-notes-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .subtasks-section {
            margin-top: 12px;
            padding-left: 32px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 13px;
            cursor: grab;
        }

        .subtask-item:active {
            cursor: grabbing;
        }

        .subtask-text[contenteditable] {
            cursor: text;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .subtask-text[contenteditable]:hover {
            background: #f9f9f9;
        }

        .subtask-text[contenteditable]:focus {
            outline: 1px solid #ccc;
            background: white;
        }

        .subtask-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .subtask-text {
            flex: 1;
        }

        .subtask-text.completed {
            text-decoration: line-through;
            color: #999;
        }

        .remove-subtask {
            color: #999;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-subtask:hover {
            color: #d32f2f;
        }

        .add-subtask-btn {
            background: none;
            border: 1px solid #e0e0e0;
            color: #666;
            font-size: 12px;
            padding: 6px 12px;
            margin-left: 32px;
            margin-top: 8px;
        }

        .add-subtask-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .subtask-form {
            display: none;
            margin-top: 8px;
        }

        .subtask-form.active {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .subtask-form input {
            flex: 1;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
        }

        .subtask-form button {
            font-size: 12px;
            padding: 6px 12px;
        }

        .edit-milestone-btn {
            background: none;
            border: 1px solid #e0e0e0;
            color: #666;
            font-size: 12px;
            padding: 6px 12px;
        }

        .edit-milestone-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .priority-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }

        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .priority-dot.done {
            cursor: default;
        }

        .priority-dot.high {
            background-color: #d32f2f;
        }

        .priority-dot.medium {
            background-color: #f57c00;
        }

        .priority-dot.low {
            background-color: #7cb342;
        }

        .priority-dot.done {
            background-color: #424242;
        }

        .priority-dot:hover {
            transform: scale(1.3);
        }

        .priority-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
        }

        .priority-menu.active {
            display: block;
        }

        .priority-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
        }

        .priority-option:hover {
            background: #f5f5f5;
        }

        .priority-option-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .calendar-year {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .calendar-year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f9f9f9;
            cursor: pointer;
            transition: background 0.2s;
        }

        .calendar-year-header:hover {
            background: #f0f0f0;
        }

        .calendar-year-title {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-year-count {
            font-size: 13px;
            color: #666;
        }

        .calendar-months {
            display: none;
            padding: 20px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .calendar-months.expanded {
            display: grid;
        }

        .calendar-month {
            background: #fafafa;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
        }

        .calendar-month-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .calendar-milestone-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .calendar-milestone-item:hover {
            background-color: #f5f5f5;
        }

        .calendar-milestone-item:last-child {
            border-bottom: none;
        }

        .calendar-milestone-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .calendar-milestone-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-milestone-text.completed {
            text-decoration: line-through;
            color: #999;
        }

        .calendar-milestone-date {
            font-size: 11px;
            color: #999;
        }

        .no-milestones-calendar {
            color: #999;
            font-size: 12px;
            font-style: italic;
        }

        .expand-icon {
            transition: transform 0.2s;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h1>PhD Tracker</h1>
            <p>Secure access with Supabase</p>
            <div class="login-buttons">
                <button class="oauth-btn github" onclick="loginWithGitHub()">
                    <span>üîó</span> Login with GitHub
                </button>
                <button class="oauth-btn google" onclick="loginWithGoogle()">
                    <span>üîç</span> Login with Google
                </button>
                <button class="oauth-btn microsoft" onclick="loginWithMicrosoft()">
                    <span>ü™ü</span> Login with Microsoft
                </button>
            </div>
            <p style="margin-top: 20px; font-size: 12px; color: #999;">Secure authentication powered by Supabase</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <div class="container">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>PhD Tracker</h1>
                        <div class="subtitle">Psychology ¬∑ Human Factors ¬∑ AI-Assisted Coding</div>
                    </div>
                    <div class="user-info">
                        <span id="userEmail" style="font-size: 14px; color: #666;"></span>
                        <button class="logout-btn" onclick="logout()">Logout</button>
                    </div>
                </div>
            </header>

            <div class="tabs">
            <div class="tab active" onclick="switchTab('calendar')">Calendar</div>
            <div class="tab" onclick="switchTab('todos')">To Do</div>
            <div class="tab" onclick="switchTab('meetings')">Meeting Notes</div>
            <div class="tab" onclick="switchTab('milestones')">CoC Milestones</div>
            <div class="tab" onclick="switchTab('study1')">Study 1</div>
            <div class="tab" onclick="switchTab('study2')">Study 2</div>
            <div class="tab" onclick="switchTab('study3')">Study 3</div>
            <div class="tab" onclick="switchTab('otherchapters')">Other Chapters</div>
            <div class="tab" onclick="switchTab('endorsement')">Endorsement</div>
            <div class="tab" onclick="switchTab('cpd')">CPD</div>
            <div class="tab" onclick="switchTab('processor')">Info Processor</div>
        </div>

        <div id="milestones" class="tab-content">
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="completedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="remainingCount">9</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="progressPercent">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>

            <div id="milestoneList"></div>

            <div class="add-milestone" onclick="openModal()">
                + Add Milestone
            </div>
        </div>

        <div id="todos" class="tab-content">
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="todosCompletedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="todosRemainingCount">0</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="todosProgressPercent">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="todosProgressBar" style="width: 0%"></div>
            </div>

            <div id="todoList"></div>

            <div class="add-milestone" onclick="openTodoModal()">
                + Add To Do
            </div>
        </div>

        <div id="study1" class="tab-content">
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="study1CompletedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="study1RemainingCount">0</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="study1ProgressPercent">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="study1ProgressBar" style="width: 0%"></div>
            </div>

            <div id="study1List"></div>

            <div class="add-milestone" onclick="openStudy1Modal()">
                + Add Item
            </div>
        </div>

        <div id="study2" class="tab-content">
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="study2CompletedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="study2RemainingCount">0</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="study2ProgressPercent">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="study2ProgressBar" style="width: 0%"></div>
            </div>

            <div id="study2List"></div>

            <div class="add-milestone" onclick="openStudy2Modal()">
                + Add Item
            </div>
        </div>

        <div id="study3" class="tab-content">
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="study3CompletedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="study3RemainingCount">0</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="study3ProgressPercent">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="study3ProgressBar" style="width: 0%"></div>
            </div>

            <div id="study3List"></div>

            <div class="add-milestone" onclick="openStudy3Modal()">
                + Add Item
            </div>
        </div>

        <div id="otherchapters" class="tab-content">
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="otherchaptersCompletedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="otherchaptersRemainingCount">0</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="otherchaptersProgressPercent">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="otherchaptersProgressBar" style="width: 0%"></div>
            </div>

            <div id="otherchaptersList"></div>

            <div class="add-milestone" onclick="openOtherChaptersModal()">
                + Add Item
            </div>
        </div>

        <div id="calendar" class="tab-content active">
            <h2 style="margin-bottom: 12px; font-size: 20px;">PhD Timeline</h2>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="background: #f5f5f5; border-radius: 6px; padding: 8px 12px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #333;" id="calendarCoCCount">0</span>
                    <span style="color: #666;">CoC</span>
                </div>
                <div style="background: #f5f5f5; border-radius: 6px; padding: 8px 12px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #333;" id="calendarTodoCount">0</span>
                    <span style="color: #666;">To Do</span>
                </div>
                <div style="background: #f5f5f5; border-radius: 6px; padding: 8px 12px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #333;" id="calendarStudy1Count">0</span>
                    <span style="color: #666;">Study 1</span>
                </div>
                <div style="background: #f5f5f5; border-radius: 6px; padding: 8px 12px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #333;" id="calendarStudy2Count">0</span>
                    <span style="color: #666;">Study 2</span>
                </div>
                <div style="background: #f5f5f5; border-radius: 6px; padding: 8px 12px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #333;" id="calendarStudy3Count">0</span>
                    <span style="color: #666;">Study 3</span>
                </div>
                <div style="background: #f5f5f5; border-radius: 6px; padding: 8px 12px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #333;" id="calendarOCCount">0</span>
                    <span style="color: #666;">Chapters</span>
                </div>
            </div>
            
            <div id="calendarView"></div>
        </div>

        <div id="processor" class="tab-content">
            <div class="info-processor">
                <h2 style="margin-bottom: 15px; font-size: 20px;">Simplify Complex Information</h2>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                    Paste any dense text (papers, emails, policy docs) and get a clear summary with key points.
                </p>
                <textarea id="inputText" placeholder="Paste your text here..."></textarea>
                <button onclick="processText()">Summarize</button>
                <div id="summaryOutput"></div>
            </div>
        </div>

        <div id="endorsement" class="tab-content">
            <div style="margin-bottom: 25px;">
                <h2 style="margin-bottom: 5px; font-size: 20px;">Organisational Psychology Endorsement</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Track your registrar program requirements (AHPRA/PsyBA + APS/COP)</p>

                <!-- Hour tracking dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: white; border: 2px solid #2196f3; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: #2196f3;" id="endorsementSupervisionHours">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Supervision Hours</div>
                            </div>
                            <div style="font-size: 18px; color: #999;">/ 80</div>
                        </div>
                        <div style="margin-top: 8px; background: #e3f2fd; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="endorsementSupervisionProgress" style="height: 100%; background: #2196f3; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div style="background: white; border: 2px solid #ff9800; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: #ff9800;" id="endorsementActiveCPDHours">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Active CPD Hours</div>
                            </div>
                            <div style="font-size: 18px; color: #999;">/ 80</div>
                        </div>
                        <div style="margin-top: 8px; background: #fff3e0; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="endorsementActiveCPDProgress" style="height: 100%; background: #ff9800; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #4caf50; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: #4caf50;" id="endorsementWeeksCompleted">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Weeks Completed</div>
                            </div>
                            <div style="font-size: 18px; color: #999;">/ 104</div>
                        </div>
                        <div style="margin-top: 8px; background: #e8f5e9; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="endorsementWeeksProgress" style="height: 100%; background: #4caf50; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <!-- Quick info -->
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Program Requirements:</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #666;">
                        <li>2 years supervised practice (104 weeks)</li>
                        <li>80 hours supervision (min. 2 hours per fortnight)</li>
                        <li>80 hours active CPD relevant to Org Psych</li>
                        <li>Minimum 17.5 hours/week work in relevant field</li>
                        <li>6-month progress reports (4 total)</li>
                        <li>Supervision logbook with detailed records</li>
                    </ul>
                </div>

                <!-- Program details form -->
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Program Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Program Start Date</label>
                            <input type="date" id="endorsementStartDate" onchange="saveEndorsementSettings()" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Expected End Date</label>
                            <input type="date" id="endorsementEndDate" readonly style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; background: #f9f9f9;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Primary Supervisor</label>
                            <input type="text" id="endorsementSupervisor" onchange="saveEndorsementSettings()" placeholder="Name" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Supervisor Email/Phone</label>
                            <input type="text" id="endorsementSupervisorContact" onchange="saveEndorsementSettings()" placeholder="Contact details" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                        </div>
                    </div>
                </div>

                <!-- Reference Documents -->
                <div style="background: #f0f7ff; border: 1px solid #90caf9; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; font-size: 16px; color: #1976d2;">Reference Documents</h3>
                    <div id="endorsementDocsList" style="display: grid; gap: 8px;">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Supervision log -->
            <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Supervision Log</h3>
                <div id="supervisionLogList"></div>
                <button onclick="openSupervisionModal()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 15px;">+ Add Supervision Session</button>
            </div>

            <!-- Progress reports tracker -->
            <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 16px;">6-Month Progress Reports</h3>
                <div id="progressReportsList"></div>
            </div>
        </div>

        <div id="cpd" class="tab-content">
            <div style="margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div>
                        <h2 style="margin-bottom: 5px; font-size: 20px;">CPD Portfolio</h2>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Track your continuing professional development for Psychology Board requirements</p>
                        <a href="https://psychology.org.au/membership/member-login?returnurl=%2fmembership%2fmembers-dashboard%3futm_medium%3dPromoTile%26utm_source%3dwebsite" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #e3f2fd; color: #1976d2; text-decoration: none; border-radius: 4px; font-size: 13px; font-weight: 500; border: 1px solid #90caf9;">
                            <span>üîó</span>
                            <span>APS Member Dashboard</span>
                        </a>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="font-size: 14px; color: #666;">
                            CPD Year:
                            <select id="cpdYearFilter" onchange="renderCPD()" style="margin-left: 8px; padding: 5px 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                            </select>
                        </label>
                        <label style="font-size: 14px; color: #666;">
                            <input type="checkbox" id="cpdFilterCheckbox" onchange="renderCPD()" style="margin-right: 5px;">
                            Show included only
                        </label>
                    </div>
                </div>

                <!-- Hour tracking dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: #333;" id="cpdTotalHours">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Total CPD Hours</div>
                            </div>
                            <div style="font-size: 18px; color: #999;">/ 30</div>
                        </div>
                        <div style="margin-top: 8px; background: #f5f5f5; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="cpdTotalProgress" style="height: 100%; background: #4caf50; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div style="background: white; border: 2px solid #2196f3; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: #2196f3;" id="cpdPeerHours">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Peer Consultation</div>
                            </div>
                            <div style="font-size: 18px; color: #999;">/ 10</div>
                        </div>
                        <div style="margin-top: 8px; background: #e3f2fd; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="cpdPeerProgress" style="height: 100%; background: #2196f3; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #ff9800; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: #ff9800;" id="cpdActiveHours">0</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Active CPD</div>
                            </div>
                            <div style="font-size: 18px; color: #999;">/ 10</div>
                        </div>
                        <div style="margin-top: 8px; background: #fff3e0; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="cpdActiveProgress" style="height: 100%; background: #ff9800; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="cpdList"></div>

            <div class="add-milestone" onclick="openCPDModal()">
                + Add CPD Activity
            </div>

            <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                <h3 style="margin-bottom: 15px; font-size: 18px; color: #333;">Reference Documents</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Store important CPD-related documents like Board guidelines, templates, policies, etc.
                </p>
                
                <div id="cpdDocumentsList" style="display: grid; gap: 10px; margin-bottom: 15px;">
                    <!-- Documents will be rendered here -->
                </div>

                <div style="background: #f9f9f9; border: 1px dashed #ccc; border-radius: 8px; padding: 15px;">
                    <div style="display: grid; grid-template-columns: 2fr 3fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Document Name</label>
                            <input type="text" id="cpdDocName" placeholder="e.g., CPD Guidelines 2024" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">File Path or URL</label>
                            <input type="text" id="cpdDocPath" placeholder="File path (Shift + Right-click ‚Üí Copy as path) or web URL" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                        </div>
                        <button onclick="addCPDDocument()" style="padding: 8px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Add Document</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="meetings" class="tab-content">
            <div class="info-processor">
                <h2 style="margin-bottom: 15px; font-size: 20px;">Supervision Meeting Notes</h2>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                    Paste your meeting notes or upload a PDF to extract action items and get a summary.
                </p>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Meeting Date</label>
                    <input type="date" id="meetingDate" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500;">Upload PDF or paste notes below:</label>
                    <input type="file" id="pdfUpload" accept=".pdf" style="margin-bottom: 10px; font-size: 13px;">
                </div>

                <textarea id="meetingText" placeholder="Or paste your meeting notes here..."></textarea>
                <div style="display: flex; gap: 10px;">
                    <button onclick="extractActions()">Extract Action Items</button>
                    <button onclick="summarizeMeeting()" style="background: #666;">Summarize Notes</button>
                </div>
                <div id="actionOutput"></div>

                <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                    <h3 style="font-size: 18px; margin-bottom: 20px;">Past Meetings</h3>
                    <div id="meetingHistory"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal" onclick="closeModalOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Milestone</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="milestoneTitle" placeholder="e.g., Submit ethics application">
            </div>
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="milestoneDate">
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="milestonePriority" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    <option value="high">üî¥ High</option>
                    <option value="medium" selected>üü† Medium</option>
                    <option value="low">üü¢ Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="milestoneDesc" placeholder="Any notes or details...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button id="milestoneDeleteBtn" class="btn-secondary" onclick="deleteMilestoneFromModal()" style="display: none; background: #d32f2f; color: white;">Delete</button>
                <select id="milestoneConvertSelect" class="btn-secondary" style="display: none; padding: 8px 12px; cursor: pointer;" onchange="convertMilestone(this.value)">
                    <option value="">Convert to...</option>
                    <option value="todo">To Do</option>
                    <option value="study1">Study 1</option>
                    <option value="study2">Study 2</option>
                    <option value="study3">Study 3</option>
                    <option value="otherchapters">Other Chapters</option>
                </select>
                <button onclick="addMilestone()">Add</button>
            </div>
        </div>
    </div>

    <div id="todoModal" class="modal" onclick="closeTodoModalOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add To Do</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="todoTitle" placeholder="e.g., Order lab materials">
            </div>
            <div class="form-group">
                <label>Due Date (optional)</label>
                <input type="date" id="todoDate">
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="todoPriority" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    <option value="high">üî¥ High</option>
                    <option value="medium" selected>üü† Medium</option>
                    <option value="low">üü¢ Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="todoDesc" placeholder="Any notes or details...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeTodoModal()">Cancel</button>
                <button id="todoDeleteBtn" class="btn-secondary" onclick="deleteTodoFromModal()" style="display: none; background: #d32f2f; color: white;">Delete</button>
                <select id="todoConvertSelect" class="btn-secondary" style="display: none; padding: 8px 12px; cursor: pointer;" onchange="convertTodo(this.value)">
                    <option value="">Convert to...</option>
                    <option value="milestone">CoC Milestone</option>
                    <option value="study1">Study 1</option>
                    <option value="study2">Study 2</option>
                    <option value="study3">Study 3</option>
                    <option value="otherchapters">Other Chapters</option>
                </select>
                <button onclick="addTodo()">Add</button>
            </div>
        </div>
    </div>

    <div id="study1Modal" class="modal" onclick="closeStudy1ModalOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Study 1 Item</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="study1Title" placeholder="e.g., Design experiment protocol">
            </div>
            <div class="form-group">
                <label>Due Date (optional)</label>
                <input type="date" id="study1Date">
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="study1Priority" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    <option value="high">üî¥ High</option>
                    <option value="medium" selected>üü† Medium</option>
                    <option value="low">üü¢ Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="study1Desc" placeholder="Any notes or details...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeStudy1Modal()">Cancel</button>
                <button id="study1DeleteBtn" class="btn-secondary" onclick="deleteStudy1FromModal()" style="display: none; background: #d32f2f; color: white;">Delete</button>
                <select id="study1ConvertSelect" class="btn-secondary" style="display: none; padding: 8px 12px; cursor: pointer;" onchange="convertStudy1(this.value)">
                    <option value="">Convert to...</option>
                    <option value="milestone">CoC Milestone</option>
                    <option value="todo">To Do</option>
                    <option value="study2">Study 2</option>
                    <option value="study3">Study 3</option>
                    <option value="otherchapters">Other Chapters</option>
                </select>
                <button onclick="addStudy1()">Add</button>
            </div>
        </div>
    </div>

    <div id="study2Modal" class="modal" onclick="closeStudy2ModalOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Study 2 Item</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="study2Title" placeholder="e.g., Design experiment protocol">
            </div>
            <div class="form-group">
                <label>Due Date (optional)</label>
                <input type="date" id="study2Date">
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="study2Priority" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    <option value="high">üî¥ High</option>
                    <option value="medium" selected>üü† Medium</option>
                    <option value="low">üü¢ Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="study2Desc" placeholder="Any notes or details...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeStudy2Modal()">Cancel</button>
                <button id="study2DeleteBtn" class="btn-secondary" onclick="deleteStudy2FromModal()" style="display: none; background: #d32f2f; color: white;">Delete</button>
                <select id="study2ConvertSelect" class="btn-secondary" style="display: none; padding: 8px 12px; cursor: pointer;" onchange="convertStudy2(this.value)">
                    <option value="">Convert to...</option>
                    <option value="milestone">CoC Milestone</option>
                    <option value="todo">To Do</option>
                    <option value="study1">Study 1</option>
                    <option value="study3">Study 3</option>
                    <option value="otherchapters">Other Chapters</option>
                </select>
                <button onclick="addStudy2()">Add</button>
            </div>
        </div>
    </div>

    <div id="study3Modal" class="modal" onclick="closeStudy3ModalOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Study 3 Item</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="study3Title" placeholder="e.g., Design experiment protocol">
            </div>
            <div class="form-group">
                <label>Due Date (optional)</label>
                <input type="date" id="study3Date">
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="study3Priority" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    <option value="high">üî¥ High</option>
                    <option value="medium" selected>üü† Medium</option>
                    <option value="low">üü¢ Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="study3Desc" placeholder="Any notes or details...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeStudy3Modal()">Cancel</button>
                <button id="study3DeleteBtn" class="btn-secondary" onclick="deleteStudy3FromModal()" style="display: none; background: #d32f2f; color: white;">Delete</button>
                <select id="study3ConvertSelect" class="btn-secondary" style="display: none; padding: 8px 12px; cursor: pointer;" onchange="convertStudy3(this.value)">
                    <option value="">Convert to...</option>
                    <option value="milestone">CoC Milestone</option>
                    <option value="todo">To Do</option>
                    <option value="study1">Study 1</option>
                    <option value="study2">Study 2</option>
                    <option value="otherchapters">Other Chapters</option>
                </select>
                <button onclick="addStudy3()">Add</button>
            </div>
        </div>
    </div>

    <div id="otherchaptersModal" class="modal" onclick="closeOtherChaptersModalOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Other Chapters Item</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="otherchaptersTitle" placeholder="e.g., Write literature review">
            </div>
            <div class="form-group">
                <label>Due Date (optional)</label>
                <input type="date" id="otherchaptersDate">
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="otherchaptersPriority" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    <option value="high">üî¥ High</option>
                    <option value="medium" selected>üü† Medium</option>
                    <option value="low">üü¢ Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="otherchaptersDesc" placeholder="Any notes or details...">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeOtherChaptersModal()">Cancel</button>
                <button id="otherchaptersDeleteBtn" class="btn-secondary" onclick="deleteOtherChaptersFromModal()" style="display: none; background: #d32f2f; color: white;">Delete</button>
                <select id="otherchaptersConvertSelect" class="btn-secondary" style="display: none; padding: 8px 12px; cursor: pointer;" onchange="convertOtherChapters(this.value)">
                    <option value="">Convert to...</option>
                    <option value="milestone">CoC Milestone</option>
                    <option value="todo">To Do</option>
                    <option value="study1">Study 1</option>
                    <option value="study2">Study 2</option>
                    <option value="study3">Study 3</option>
                </select>
                <button onclick="addOtherChapters()">Add</button>
            </div>
        </div>
    </div>

    <div id="cpdModal" class="modal" onclick="closeCPDModalOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add CPD Activity</h2>
            <div class="form-group">
                <label>Activity Title</label>
                <input type="text" id="cpdTitle" placeholder="e.g., Research Methods Workshop">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="cpdDate">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Activity Type</label>
                    <select id="cpdType" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        <option value="active">Active CPD (workshop, conference, etc.)</option>
                        <option value="peer">Peer Consultation/Supervision</option>
                        <option value="passive">Passive CPD (reading, webinar)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Hours</label>
                    <input type="number" id="cpdHours" placeholder="e.g., 2" step="0.5" min="0" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                </div>
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <textarea id="cpdDesc" placeholder="What was this activity about?" style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>Reflection Journal (required by Psychology Board)</label>
                <textarea id="cpdReflection" placeholder="Reflect on what you learned and how it relates to your practice..." style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="cpdIncluded" checked>
                    <span>Include in CPD Portfolio</span>
                </label>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeCPDModal()">Cancel</button>
                <button id="cpdDeleteBtn" class="btn-secondary" onclick="deleteCPDFromModal()" style="display: none; background: #d32f2f; color: white;">Delete</button>
                <button onclick="addCPD()">Add</button>
            </div>
        </div>
    </div>

    <script>
        // Default milestones for Psychology PhD (Macquarie - Feb 2026 intake)
        // CoC due between Aug 1 - Oct 1, 2026 for full-time students
        const defaultMilestones = [
            {
                title: "Complete Academic Integrity Module",
                date: "2026-04-30",
                description: "Mandatory module - submit certificate with CoC documentation",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "medium"
            },
            {
                title: "Complete Safer Communities @MQ Module",
                date: "2026-04-30",
                description: "Mandatory module - submit certificate with CoC documentation",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "medium"
            },
            {
                title: "Complete Graduate Research Induction",
                date: "2026-04-30",
                description: "Mandatory module - submit certificate with CoC documentation",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "medium"
            },
            {
                title: "Complete Faculty Commencement Quiz",
                date: "2026-04-30",
                description: "Review key info related to research candidature",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "medium"
            },
            {
                title: "Submit Data Management Plan (DMP)",
                date: "2026-06-30",
                description: "Submit via FoRA portal - must include PDF and 'lodgement complete' email",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "high"
            },
            {
                title: "Obtain Human Ethics Approval",
                date: "2026-07-15",
                description: "HREC approval required before starting research - cannot be retrospective",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "high"
            },
            {
                title: "Prepare Research Proposal & Budget",
                date: "2026-07-31",
                description: "Formal thesis proposal + 1-page budget. Check School of Psych Sciences guidelines",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "high"
            },
            {
                title: "Present Research Proposal to Panel",
                date: "2026-08-15",
                description: "Presentation to panel of experts - not formally assessed, for feedback",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "high"
            },
            {
                title: "Submit CoC Documentation Package",
                date: "2026-09-01",
                description: "All docs to supervisor ‚Üí RTD ‚Üí adrtp.fmhhs@mq.edu.au. Due between Aug 1 - Oct 1",
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: "high"
            }
        ];

        let milestones = JSON.parse(localStorage.getItem('phdMilestones')) || defaultMilestones;
        let meetings = JSON.parse(localStorage.getItem('phdMeetings')) || [];
        let todos = JSON.parse(localStorage.getItem('phdTodos')) || [];
        let study1Items = JSON.parse(localStorage.getItem('phdStudy1')) || [];
        let study2Items = JSON.parse(localStorage.getItem('phdStudy2')) || [];
        let study3Items = JSON.parse(localStorage.getItem('phdStudy3')) || [];
        let otherChaptersItems = JSON.parse(localStorage.getItem('phdOtherChapters')) || [];
        let cpdEvents = JSON.parse(localStorage.getItem('phdCPD')) || [];
        let cpdDocuments = JSON.parse(localStorage.getItem('phdCPDDocs')) || [];

        function renderMilestones() {
            const list = document.getElementById('milestoneList');
            list.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Sort: incomplete first (by date), then completed at bottom (by date)
            const sortedMilestones = [...milestones].sort((a, b) => {
                // If completion status differs, incomplete comes first
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                // If same completion status, sort by date
                return new Date(a.date) - new Date(b.date);
            });

            sortedMilestones.forEach((m) => {
                // Find original index for event handlers
                const index = milestones.indexOf(m);
                
                const dueDate = new Date(m.date);
                const isOverdue = !m.completed && dueDate < today;
                
                // Ensure all fields exist
                if (!m.attachments) m.attachments = [];
                if (!m.notes) m.notes = "";
                if (!m.subtasks) m.subtasks = [];
                if (!m.priority) m.priority = "medium";
                
                const div = document.createElement('div');
                div.className = 'milestone' + (m.completed ? ' completed' : '');
                div.innerHTML = `
                    <div class="milestone-header">
                        <input type="checkbox" class="checkbox" ${m.completed ? 'checked' : ''} 
                               onchange="toggleMilestone(${index})">
                        <div style="flex: 1;">
                            <div class="milestone-title">${m.title}</div>
                            <div class="milestone-date ${isOverdue ? 'overdue' : ''}">
                                ${formatDate(m.date)} ${isOverdue ? '(overdue)' : ''}
                            </div>
                        </div>
                        <div class="priority-indicator">
                            <div class="priority-dot ${m.completed ? 'done' : (m.priority || 'medium')}" 
                                 onclick="togglePriorityMenu(${index}, event)" 
                                 title="${m.completed ? 'Done' : ((m.priority || 'medium').charAt(0).toUpperCase() + (m.priority || 'medium').slice(1) + ' priority')}">
                            </div>
                            <div class="priority-menu" id="priority-menu-${index}">
                                <div class="priority-option" onclick="setPriority(${index}, 'high')">
                                    <div class="priority-option-dot high"></div>
                                    <span>High</span>
                                </div>
                                <div class="priority-option" onclick="setPriority(${index}, 'medium')">
                                    <div class="priority-option-dot medium"></div>
                                    <span>Medium</span>
                                </div>
                                <div class="priority-option" onclick="setPriority(${index}, 'low')">
                                    <div class="priority-option-dot low"></div>
                                    <span>Low</span>
                                </div>
                            </div>
                        </div>
                        <button class="edit-milestone-btn" onclick="openEditModal(${index})">Edit</button>
                    </div>
                    ${m.description ? `<div class="milestone-description">${m.description}</div>` : ''}
                    
                    ${m.subtasks.length > 0 ? `
                        <div class="subtasks-section">
                            ${m.subtasks.map((subtask, subIndex) => `
                                <div class="subtask-item" draggable="true" ondragstart="dragStartSubtask(event, ${index}, ${subIndex})" ondragover="dragOverSubtask(event)" ondrop="dropSubtask(event, ${index}, ${subIndex})">
                                    <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                           onchange="toggleSubtask(${index}, ${subIndex})">
                                    <span class="subtask-text ${subtask.completed ? 'completed' : ''}" 
                                          contenteditable="true" 
                                          onblur="updateSubtaskText(${index}, ${subIndex}, this.textContent)"
                                          onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${subtask.text}</span>
                                    <span class="remove-subtask" onclick="removeSubtask(${index}, ${subIndex})">‚úï</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="add-subtask-btn" onclick="showSubtaskForm(${index})">+ Add Subtask</button>
                    <div class="subtask-form" id="subtask-form-${index}">
                        <input type="text" id="subtask-input-${index}" placeholder="Enter subtask...">
                        <button onclick="saveSubtask(${index})">Add</button>
                        <button class="btn-secondary" onclick="hideSubtaskForm(${index})">Cancel</button>
                    </div>

                    ${m.attachments.length > 0 ? `
                        <div class="attachments">
                            ${m.attachments.map((att, attIndex) => `
                                <div class="attachment-item">
                                    <a href="${att.url}" target="_blank" class="attachment-link" title="${att.url}">
                                        üìé ${att.name}
                                    </a>
                                    <span class="remove-attachment" onclick="removeAttachment(${index}, ${attIndex})">‚úï</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="add-attachment-btn" onclick="showAttachmentForm(${index})">+ Add Link</button>
                    <div class="attachment-form" id="attachment-form-${index}">
                        <input type="text" id="attachment-name-${index}" placeholder="Link name (e.g., 'Ethics application draft')">
                        <input type="text" id="attachment-url-${index}" placeholder="Web link OR file path (Shift + Right-click ‚Üí Copy as path)">
                        <div class="attachment-form-buttons">
                            <button onclick="saveAttachment(${index})">Save</button>
                            <button class="btn-secondary" onclick="hideAttachmentForm(${index})">Cancel</button>
                        </div>
                    </div>

                    <div class="milestone-notes">
                        ${m.notes ? `<div class="notes-display">${m.notes}</div>` : ''}
                        <button class="add-notes-btn" onclick="showNotesForm(${index})">${m.notes ? 'Edit Notes' : '+ Add Notes'}</button>
                        <div class="notes-form" id="notes-form-${index}">
                            <textarea id="notes-textarea-${index}" placeholder="Add notes, progress updates, reminders...">${m.notes || ''}</textarea>
                            <div class="notes-buttons">
                                <button onclick="saveNotes(${index})">Save</button>
                                <button class="btn-secondary" onclick="hideNotesForm(${index})">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            updateStats();
        }

        function toggleMilestone(index) {
            const wasCompleted = milestones[index].completed;
            milestones[index].completed = !wasCompleted;
            
            // If unchecking a completed milestone, reset priority to medium
            if (wasCompleted && !milestones[index].completed) {
                milestones[index].priority = 'medium';
            }
            
            saveMilestones();
            renderMilestones();
        }

        function updateStats() {
            const completed = milestones.filter(m => m.completed).length;
            const total = milestones.length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('completedCount').textContent = completed;
            document.getElementById('remainingCount').textContent = total - completed;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function saveMilestones() {
            localStorage.setItem('phdMilestones', JSON.stringify(milestones));
            renderCalendar(); // Update calendar when milestones change
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Render content for tabs that need it
            if (tabName === 'endorsement') {
                renderEndorsement();
            } else if (tabName === 'cpd') {
                renderCPD();
            } else if (tabName === 'meetings') {
                renderMeetings();
            } else if (tabName === 'calendar') {
                renderCalendar();
            }
        }

        function openModal() {
            document.getElementById('modal').classList.add('active');
            document.getElementById('milestoneTitle').value = '';
            document.getElementById('milestoneDate').value = '';
            document.getElementById('milestoneDesc').value = '';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            // Reset modal to add mode
            document.querySelector('#modal h2').textContent = 'Add Milestone';
            document.querySelector('#modal .modal-buttons button:last-child').textContent = 'Add';
            document.querySelector('#modal .modal-buttons button:last-child').onclick = addMilestone;
            document.getElementById('milestoneDeleteBtn').style.display = 'none';
            document.getElementById('milestoneConvertSelect').style.display = 'none';
            editingIndex = null;
        }

        function closeModalOnOutside(event) {
            if (event.target.id === 'modal') {
                closeModal();
            }
        }

        function addMilestone() {
            const title = document.getElementById('milestoneTitle').value.trim();
            const date = document.getElementById('milestoneDate').value;
            const description = document.getElementById('milestoneDesc').value.trim();
            const priority = document.getElementById('milestonePriority').value;

            if (!title || !date) {
                alert('Please fill in title and date');
                return;
            }

            milestones.push({
                title,
                date,
                description,
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: priority
            });

            milestones.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveMilestones();
            renderMilestones();
            closeModal();
        }

        let editingIndex = null;

        function openEditModal(index) {
            editingIndex = index;
            const milestone = milestones[index];
            
            document.getElementById('milestoneTitle').value = milestone.title;
            document.getElementById('milestoneDate').value = milestone.date;
            document.getElementById('milestoneDesc').value = milestone.description || '';
            document.getElementById('milestonePriority').value = milestone.priority || 'medium';
            
            // Change modal title and button text
            document.querySelector('#modal h2').textContent = 'Edit Milestone';
            document.querySelector('#modal .modal-buttons button:last-child').textContent = 'Update';
            document.querySelector('#modal .modal-buttons button:last-child').onclick = updateMilestone;
            
            // Show delete and convert dropdown
            document.getElementById('milestoneDeleteBtn').style.display = 'block';
            document.getElementById('milestoneConvertSelect').style.display = 'inline-block';
            document.getElementById('milestoneConvertSelect').value = '';
            
            document.getElementById('modal').classList.add('active');
        }

        function deleteMilestoneFromModal() {
            if (confirm('Are you sure you want to delete this milestone? This cannot be undone.')) {
                milestones.splice(editingIndex, 1);
                saveMilestones();
                renderMilestones();
                closeModal();
            }
        }

        function convertMilestone(targetType) {
            if (!targetType) return;
            const milestone = milestones[editingIndex];
            const targetMap = {
                'todo': { array: todos, name: 'To Do', storage: saveTodos, render: renderTodos },
                'study1': { array: study1Items, name: 'Study 1', storage: saveStudy1, render: renderStudy1 },
                'study2': { array: study2Items, name: 'Study 2', storage: saveStudy2, render: renderStudy2 },
                'study3': { array: study3Items, name: 'Study 3', storage: saveStudy3, render: renderStudy3 },
                'otherchapters': { array: otherChaptersItems, name: 'Other Chapters', storage: saveOtherChapters, render: renderOtherChapters }
            };
            
            const target = targetMap[targetType];
            if (!target) return;
            
            if (confirm(`Convert this milestone to ${target.name}?`)) {
                target.array.push({
                    title: milestone.title,
                    date: milestone.date,
                    description: milestone.description,
                    completed: milestone.completed,
                    attachments: milestone.attachments || [],
                    notes: milestone.notes || '',
                    subtasks: milestone.subtasks || [],
                    priority: milestone.priority || 'medium'
                });
                
                milestones.splice(editingIndex, 1);
                saveMilestones();
                target.storage();
                renderMilestones();
                target.render();
                closeModal();
                alert(`Converted to ${target.name}!`);
            }
        }

        function updateMilestone() {
            const title = document.getElementById('milestoneTitle').value.trim();
            const date = document.getElementById('milestoneDate').value;
            const description = document.getElementById('milestoneDesc').value.trim();
            const priority = document.getElementById('milestonePriority').value;

            if (!title || !date) {
                alert('Please fill in title and date');
                return;
            }

            milestones[editingIndex].title = title;
            milestones[editingIndex].date = date;
            milestones[editingIndex].description = description;
            milestones[editingIndex].priority = priority;

            milestones.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveMilestones();
            renderMilestones();
            closeModal();
            
            // Reset modal to add mode
            document.querySelector('#modal h2').textContent = 'Add Milestone';
            document.querySelector('#modal .modal-buttons button:last-child').textContent = 'Add';
            document.querySelector('#modal .modal-buttons button:last-child').onclick = addMilestone;
            editingIndex = null;
        }

        function showAttachmentForm(index) {
            // Hide all other forms
            document.querySelectorAll('.attachment-form').forEach(form => {
                form.classList.remove('active');
            });
            // Show this form
            document.getElementById(`attachment-form-${index}`).classList.add('active');
        }

        function hideAttachmentForm(index) {
            document.getElementById(`attachment-form-${index}`).classList.remove('active');
            document.getElementById(`attachment-name-${index}`).value = '';
            document.getElementById(`attachment-url-${index}`).value = '';
        }

        function saveAttachment(index) {
            const name = document.getElementById(`attachment-name-${index}`).value.trim();
            const url = document.getElementById(`attachment-url-${index}`).value.trim();

            if (!name || !url) {
                alert('Please fill in both link name and path/URL');
                return;
            }

            if (!milestones[index].attachments) {
                milestones[index].attachments = [];
            }

            milestones[index].attachments.push({ name, url });
            saveMilestones();
            renderMilestones();
        }

        function removeAttachment(milestoneIndex, attachmentIndex) {
            if (confirm('Remove this attachment?')) {
                milestones[milestoneIndex].attachments.splice(attachmentIndex, 1);
                saveMilestones();
                renderMilestones();
            }
        }

        function showNotesForm(index) {
            document.getElementById(`notes-form-${index}`).classList.add('active');
        }

        function hideNotesForm(index) {
            document.getElementById(`notes-form-${index}`).classList.remove('active');
        }

        function saveNotes(index) {
            const notes = document.getElementById(`notes-textarea-${index}`).value.trim();
            milestones[index].notes = notes;
            saveMilestones();
            renderMilestones();
        }

        function showSubtaskForm(index) {
            // Hide all other forms
            document.querySelectorAll('.subtask-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`subtask-form-${index}`).classList.add('active');
            document.getElementById(`subtask-input-${index}`).focus();
        }

        function hideSubtaskForm(index) {
            document.getElementById(`subtask-form-${index}`).classList.remove('active');
            document.getElementById(`subtask-input-${index}`).value = '';
        }

        function saveSubtask(index) {
            const text = document.getElementById(`subtask-input-${index}`).value.trim();
            
            if (!text) {
                alert('Please enter a subtask');
                return;
            }

            if (!milestones[index].subtasks) {
                milestones[index].subtasks = [];
            }

            milestones[index].subtasks.push({
                text: text,
                completed: false
            });

            saveMilestones();
            renderMilestones();
        }

        function toggleSubtask(milestoneIndex, subtaskIndex) {
            milestones[milestoneIndex].subtasks[subtaskIndex].completed = 
                !milestones[milestoneIndex].subtasks[subtaskIndex].completed;
            saveMilestones();
            renderMilestones();
        }

        function removeSubtask(milestoneIndex, subtaskIndex) {
            if (confirm('Remove this subtask?')) {
                milestones[milestoneIndex].subtasks.splice(subtaskIndex, 1);
                saveMilestones();
                renderMilestones();
            }
        }

        // Subtask drag and drop
        let draggedSubtask = null;
        
        function dragStartSubtask(event, itemIndex, subtaskIndex) {
            draggedSubtask = { type: 'milestone', itemIndex, subtaskIndex };
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function dragOverSubtask(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function dropSubtask(event, itemIndex, subtaskIndex) {
            event.preventDefault();
            if (!draggedSubtask || draggedSubtask.type !== 'milestone' || draggedSubtask.itemIndex !== itemIndex) return;
            
            const fromIndex = draggedSubtask.subtaskIndex;
            const toIndex = subtaskIndex;
            
            if (fromIndex === toIndex) return;
            
            const subtasks = milestones[itemIndex].subtasks;
            const [movedItem] = subtasks.splice(fromIndex, 1);
            subtasks.splice(toIndex, 0, movedItem);
            
            saveMilestones();
            renderMilestones();
            draggedSubtask = null;
        }
        
        function updateSubtaskText(itemIndex, subtaskIndex, newText) {
            const trimmed = newText.trim();
            if (trimmed && trimmed !== milestones[itemIndex].subtasks[subtaskIndex].text) {
                milestones[itemIndex].subtasks[subtaskIndex].text = trimmed;
                saveMilestones();
            }
            renderMilestones();
        }

        function togglePriorityMenu(index, event) {
            event.stopPropagation();
            
            // Don't allow changing priority if milestone is completed
            if (milestones[index].completed) {
                return;
            }
            
            const menu = document.getElementById(`priority-menu-${index}`);
            
            // Close all other priority menus
            document.querySelectorAll('.priority-menu').forEach(m => {
                if (m !== menu) m.classList.remove('active');
            });
            
            menu.classList.toggle('active');
        }

        function setPriority(index, priority) {
            milestones[index].priority = priority;
            saveMilestones();
            renderMilestones();
        }

        // Close priority menus when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.priority-menu').forEach(m => {
                m.classList.remove('active');
            });
        });

        async function processText() {
            const text = document.getElementById('inputText').value.trim();
            const output = document.getElementById('summaryOutput');

            if (!text) {
                alert('Please paste some text first');
                return;
            }

            output.innerHTML = '<div class="summary">Processing...</div>';

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `You're helping a Psychology PhD student understand dense academic/administrative text. Provide:

1. A 2-3 sentence summary in plain language
2. 3-5 key takeaways or action items
3. Any deadlines or important dates mentioned

Keep it concise and practical.

Text to summarize:
${text}`
                        }]
                    })
                });

                const data = await response.json();
                const summary = data.content.find(c => c.type === 'text')?.text || 'Could not process text';

                output.innerHTML = `
                    <div class="summary">
                        <h3>Summary</h3>
                        ${summary.split('\n').map(line => `<p>${line}</p>`).join('')}
                    </div>
                `;
            } catch (error) {
                output.innerHTML = `<div class="summary" style="color: #d32f2f;">Error processing text. Please try again.</div>`;
            }
        }

        async function extractActions() {
            let text = document.getElementById('meetingText').value.trim();
            const pdfFile = document.getElementById('pdfUpload').files[0];
            const date = document.getElementById('meetingDate').value;
            const output = document.getElementById('actionOutput');

            // Get text from PDF if uploaded
            if (pdfFile) {
                output.innerHTML = '<div class="summary">Reading PDF...</div>';
                try {
                    text = await readPDFText(pdfFile);
                    // Display extracted text in textarea for reference
                    document.getElementById('meetingText').value = text;
                } catch (error) {
                    output.innerHTML = `<div class="summary" style="color: #d32f2f;">Error reading PDF. Please try pasting text instead.</div>`;
                    return;
                }
            }

            if (!text) {
                alert('Please upload a PDF or paste your meeting notes');
                return;
            }

            if (!date) {
                alert('Please select the meeting date');
                return;
            }

            output.innerHTML = '<div class="summary">Extracting action items...</div>';

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Extract action items from these supervision meeting notes. For each action item, provide:
1. What needs to be done (clear, actionable statement)
2. Any deadline mentioned (if applicable)
3. Priority level if indicated (high/medium/low)

Format as a simple list. Be specific and practical. Only include actual action items, not general discussion points.

Meeting notes:
${text}`
                        }]
                    })
                });

                const data = await response.json();
                const actions = data.content.find(c => c.type === 'text')?.text || 'Could not extract actions';

                // Save meeting
                meetings.unshift({
                    date: date,
                    notes: text,
                    actions: actions,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('phdMeetings', JSON.stringify(meetings));

                output.innerHTML = `
                    <div class="summary">
                        <h3>Action Items</h3>
                        ${actions.split('\n').map(line => line.trim() ? `<p>${line}</p>` : '').join('')}
                        <button class="add-to-milestones" onclick="addActionsToMilestones(\`${actions.replace(/`/g, '\\`')}\`)">
                            Add to Milestones
                        </button>
                    </div>
                `;

                // Clear form and refresh history
                document.getElementById('meetingText').value = '';
                document.getElementById('meetingDate').value = '';
                document.getElementById('pdfUpload').value = '';
                renderMeetingHistory();

            } catch (error) {
                output.innerHTML = `<div class="summary" style="color: #d32f2f;">Error extracting actions. Please try again.</div>`;
            }
        }

        async function summarizeMeeting() {
            let text = document.getElementById('meetingText').value.trim();
            const pdfFile = document.getElementById('pdfUpload').files[0];
            const output = document.getElementById('actionOutput');

            // Get text from PDF if uploaded
            if (pdfFile) {
                output.innerHTML = '<div class="summary">Reading PDF...</div>';
                try {
                    text = await readPDFText(pdfFile);
                    // Display extracted text in textarea for reference
                    document.getElementById('meetingText').value = text;
                } catch (error) {
                    output.innerHTML = `<div class="summary" style="color: #d32f2f;">Error reading PDF. Please try pasting text instead.</div>`;
                    return;
                }
            }

            if (!text) {
                alert('Please upload a PDF or paste your meeting notes');
                return;
            }

            output.innerHTML = '<div class="summary">Summarizing your notes...</div>';

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `These are disparate notes from a PhD supervision meeting. Please provide:

1. A clear, organized summary of the main discussion points
2. Key decisions made
3. Next steps or follow-up items

Keep it concise and well-structured.

Meeting notes:
${text}`
                        }]
                    })
                });

                const data = await response.json();
                const summary = data.content.find(c => c.type === 'text')?.text || 'Could not summarize notes';

                output.innerHTML = `
                    <div class="summary">
                        <h3>Meeting Summary</h3>
                        ${summary.split('\n').map(line => line.trim() ? `<p>${line}</p>` : '').join('')}
                    </div>
                `;

            } catch (error) {
                output.innerHTML = `<div class="summary" style="color: #d32f2f;">Error summarizing notes. Please try again.</div>`;
            }
        }

        async function readPDFText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const typedarray = new Uint8Array(e.target.result);
                    
                    try {
                        // Load PDF.js library
                        const pdfjsLib = window['pdfjs-dist/build/pdf'];
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        
                        // Extract text from all pages
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n\n';
                        }
                        
                        resolve(fullText.trim());
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function renderMeetingHistory() {
            const container = document.getElementById('meetingHistory');
            
            if (meetings.length === 0) {
                container.innerHTML = '<div class="no-meetings">No meetings recorded yet</div>';
                return;
            }

            container.innerHTML = meetings.map((meeting, index) => `
                <div class="meeting-card">
                    <div class="meeting-header">
                        <div class="meeting-date-label">${formatDate(meeting.date)}</div>
                        <div class="delete-meeting" onclick="deleteMeeting(${index})">Delete</div>
                    </div>
                    <div class="action-list">
                        ${meeting.actions.split('\n')
                            .filter(line => line.trim())
                            .map(line => `<div class="action-item">${line.replace(/^[-*‚Ä¢]\s*/, '')}</div>`)
                            .join('')}
                    </div>
                </div>
            `).join('');
        }

        function deleteMeeting(index) {
            if (confirm('Delete this meeting record?')) {
                meetings.splice(index, 1);
                localStorage.setItem('phdMeetings', JSON.stringify(meetings));
                renderMeetingHistory();
            }
        }

        function addActionsToMilestones(actionsText) {
            // Simple parser - could be enhanced
            const lines = actionsText.split('\n').filter(l => l.trim());
            let added = 0;

            lines.forEach(line => {
                // Skip headers or empty lines
                if (line.includes(':') && line.split(':')[1].trim()) {
                    const title = line.split(':')[1].trim();
                    if (title.length > 10) { // Reasonable action item
                        milestones.push({
                            title: title,
                            date: '', // User can set later
                            description: 'From supervision meeting',
                            completed: false
                        });
                        added++;
                    }
                }
            });

            if (added > 0) {
                saveMilestones();
                renderMilestones();
                alert(`Added ${added} action item(s) to milestones. Set due dates in the Milestones tab.`);
            } else {
                alert('No clear action items found to add. You can manually add them in the Milestones tab.');
            }
        }

        // Initialize
        renderMilestones();
        renderMeetingHistory();
        renderCalendar();
        renderTodos();
        renderStudy1();
        renderStudy2();
        renderStudy3();
        renderOtherChapters();
        renderCPD();

        function renderTodos() {
            const list = document.getElementById('todoList');
            list.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Sort: incomplete first (by date), then completed at bottom (by date)
            const sortedTodos = [...todos].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                // Todos without dates go last among incomplete
                if (!a.date && b.date) return 1;
                if (a.date && !b.date) return -1;
                if (!a.date && !b.date) return 0;
                return new Date(a.date) - new Date(b.date);
            });

            sortedTodos.forEach((t) => {
                const index = todos.indexOf(t);
                
                const dueDate = t.date ? new Date(t.date) : null;
                const isOverdue = !t.completed && dueDate && dueDate < today;
                
                if (!t.attachments) t.attachments = [];
                if (!t.notes) t.notes = "";
                if (!t.subtasks) t.subtasks = [];
                if (!t.priority) t.priority = "medium";
                
                const div = document.createElement('div');
                div.className = 'milestone' + (t.completed ? ' completed' : '');
                div.innerHTML = `
                    <div class="milestone-header">
                        <input type="checkbox" class="checkbox" ${t.completed ? 'checked' : ''} 
                               onchange="toggleTodo(${index})">
                        <div style="flex: 1;">
                            <div class="milestone-title">${t.title}</div>
                            ${t.date ? `<div class="milestone-date ${isOverdue ? 'overdue' : ''}">
                                ${formatDate(t.date)} ${isOverdue ? '(overdue)' : ''}
                            </div>` : '<div class="milestone-date" style="color: #999;">No due date</div>'}
                        </div>
                        <div class="priority-indicator">
                            <div class="priority-dot ${t.completed ? 'done' : (t.priority || 'medium')}" 
                                 onclick="toggleTodoPriorityMenu(${index}, event)" 
                                 title="${t.completed ? 'Done' : ((t.priority || 'medium').charAt(0).toUpperCase() + (t.priority || 'medium').slice(1) + ' priority')}">
                            </div>
                            <div class="priority-menu" id="todo-priority-menu-${index}">
                                <div class="priority-option" onclick="setTodoPriority(${index}, 'high')">
                                    <div class="priority-option-dot high"></div>
                                    <span>High</span>
                                </div>
                                <div class="priority-option" onclick="setTodoPriority(${index}, 'medium')">
                                    <div class="priority-option-dot medium"></div>
                                    <span>Medium</span>
                                </div>
                                <div class="priority-option" onclick="setTodoPriority(${index}, 'low')">
                                    <div class="priority-option-dot low"></div>
                                    <span>Low</span>
                                </div>
                            </div>
                        </div>
                        <button class="edit-milestone-btn" onclick="openEditTodoModal(${index})">Edit</button>
                    </div>
                    ${t.description ? `<div class="milestone-description">${t.description}</div>` : ''}
                    
                    ${t.subtasks.length > 0 ? `
                        <div class="subtasks-section">
                            ${t.subtasks.map((subtask, subIndex) => `
                                <div class="subtask-item" draggable="true" ondragstart="dragStartTodoSubtask(event, ${index}, ${subIndex})" ondragover="dragOverSubtask(event)" ondrop="dropTodoSubtask(event, ${index}, ${subIndex})">
                                    <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                           onchange="toggleTodoSubtask(${index}, ${subIndex})">
                                    <span class="subtask-text ${subtask.completed ? 'completed' : ''}" 
                                          contenteditable="true" 
                                          onblur="updateTodoSubtaskText(${index}, ${subIndex}, this.textContent)"
                                          onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${subtask.text}</span>
                                    <span class="remove-subtask" onclick="removeTodoSubtask(${index}, ${subIndex})">‚úï</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="add-subtask-btn" onclick="showTodoSubtaskForm(${index})">+ Add Subtask</button>
                    <div class="subtask-form" id="todo-subtask-form-${index}">
                        <input type="text" id="todo-subtask-input-${index}" placeholder="Enter subtask...">
                        <button onclick="saveTodoSubtask(${index})">Add</button>
                        <button class="btn-secondary" onclick="hideTodoSubtaskForm(${index})">Cancel</button>
                    </div>

                    ${t.attachments.length > 0 ? `
                        <div class="attachments">
                            ${t.attachments.map((att, attIndex) => `
                                <div class="attachment-item">
                                    <a href="${att.url}" target="_blank" class="attachment-link" title="${att.url}">
                                        üìé ${att.name}
                                    </a>
                                    <span class="remove-attachment" onclick="removeTodoAttachment(${index}, ${attIndex})">‚úï</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="add-attachment-btn" onclick="showTodoAttachmentForm(${index})">+ Add Link</button>
                    <div class="attachment-form" id="todo-attachment-form-${index}">
                        <input type="text" id="todo-attachment-name-${index}" placeholder="Link name (e.g., 'Reference document')">
                        <input type="text" id="todo-attachment-url-${index}" placeholder="Web link OR file path (Shift + Right-click ‚Üí Copy as path)">
                        <div class="attachment-form-buttons">
                            <button onclick="saveTodoAttachment(${index})">Save</button>
                            <button class="btn-secondary" onclick="hideTodoAttachmentForm(${index})">Cancel</button>
                        </div>
                    </div>

                    <div class="milestone-notes">
                        ${t.notes ? `<div class="notes-display">${t.notes}</div>` : ''}
                        <button class="add-notes-btn" onclick="showTodoNotesForm(${index})">${t.notes ? 'Edit Notes' : '+ Add Notes'}</button>
                        <div class="notes-form" id="todo-notes-form-${index}">
                            <textarea id="todo-notes-textarea-${index}" placeholder="Add notes, progress updates, reminders...">${t.notes || ''}</textarea>
                            <div class="notes-buttons">
                                <button onclick="saveTodoNotes(${index})">Save</button>
                                <button class="btn-secondary" onclick="hideTodoNotesForm(${index})">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            updateTodoStats();
        }

        function updateTodoStats() {
            const completed = todos.filter(t => t.completed).length;
            const total = todos.length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('todosCompletedCount').textContent = completed;
            document.getElementById('todosRemainingCount').textContent = total - completed;
            document.getElementById('todosProgressPercent').textContent = percent + '%';
            document.getElementById('todosProgressBar').style.width = percent + '%';
        }

        function saveTodos() {
            localStorage.setItem('phdTodos', JSON.stringify(todos));
            renderCalendar(); // Update calendar when todos change
        }

        function toggleTodo(index) {
            const wasCompleted = todos[index].completed;
            todos[index].completed = !wasCompleted;
            
            if (wasCompleted && !todos[index].completed) {
                todos[index].priority = 'medium';
            }
            
            saveTodos();
            renderTodos();
        }

        function toggleTodoPriorityMenu(index, event) {
            event.stopPropagation();
            
            if (todos[index].completed) {
                return;
            }
            
            const menu = document.getElementById(`todo-priority-menu-${index}`);
            
            document.querySelectorAll('.priority-menu').forEach(m => {
                if (m !== menu) m.classList.remove('active');
            });
            
            menu.classList.toggle('active');
        }

        function setTodoPriority(index, priority) {
            todos[index].priority = priority;
            saveTodos();
            renderTodos();
        }

        // Todo subtask functions
        function showTodoSubtaskForm(index) {
            document.querySelectorAll('.subtask-form').forEach(form => form.classList.remove('active'));
            document.getElementById(`todo-subtask-form-${index}`).classList.add('active');
            document.getElementById(`todo-subtask-input-${index}`).focus();
        }

        function hideTodoSubtaskForm(index) {
            document.getElementById(`todo-subtask-form-${index}`).classList.remove('active');
            document.getElementById(`todo-subtask-input-${index}`).value = '';
        }

        function saveTodoSubtask(index) {
            const text = document.getElementById(`todo-subtask-input-${index}`).value.trim();
            if (!text) {
                alert('Please enter a subtask');
                return;
            }
            if (!todos[index].subtasks) todos[index].subtasks = [];
            todos[index].subtasks.push({ text: text, completed: false });
            saveTodos();
            renderTodos();
        }

        function toggleTodoSubtask(todoIndex, subtaskIndex) {
            todos[todoIndex].subtasks[subtaskIndex].completed = !todos[todoIndex].subtasks[subtaskIndex].completed;
            saveTodos();
            renderTodos();
        }

        function removeTodoSubtask(todoIndex, subtaskIndex) {
            if (confirm('Remove this subtask?')) {
                todos[todoIndex].subtasks.splice(subtaskIndex, 1);
                saveTodos();
                renderTodos();
            }
        }

        function dragStartTodoSubtask(event, itemIndex, subtaskIndex) {
            draggedSubtask = { type: 'todo', itemIndex, subtaskIndex };
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function dropTodoSubtask(event, itemIndex, subtaskIndex) {
            event.preventDefault();
            if (!draggedSubtask || draggedSubtask.type !== 'todo' || draggedSubtask.itemIndex !== itemIndex) return;
            
            const fromIndex = draggedSubtask.subtaskIndex;
            const toIndex = subtaskIndex;
            
            if (fromIndex === toIndex) return;
            
            const subtasks = todos[itemIndex].subtasks;
            const [movedItem] = subtasks.splice(fromIndex, 1);
            subtasks.splice(toIndex, 0, movedItem);
            
            saveTodos();
            renderTodos();
            draggedSubtask = null;
        }
        
        function updateTodoSubtaskText(itemIndex, subtaskIndex, newText) {
            const trimmed = newText.trim();
            if (trimmed && trimmed !== todos[itemIndex].subtasks[subtaskIndex].text) {
                todos[itemIndex].subtasks[subtaskIndex].text = trimmed;
                saveTodos();
            }
            renderTodos();
        }
// ========== CPD Functions (Updated) ==========

// Generate CPD years (Dec to Nov cycles)
function generateCPDYears() {
    const select = document.getElementById('cpdYearFilter');
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth(); // 0-11
    const currentYear = currentDate.getFullYear();
    
    // If we're in Jan-Nov, current CPD year started last Dec
    // If we're in Dec, current CPD year started this Dec
    const startYear = currentMonth === 11 ? currentYear : currentYear - 1;
    
    // Generate 5 years: 2 past, current, 2 future
    const years = [];
    for (let i = -2; i <= 2; i++) {
        const year = startYear + i;
        years.push(`${year}-${year + 1}`);
    }
    
    select.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    // Set current year as selected
    select.value = `${startYear}-${startYear + 1}`;
}

function renderCPD() {
    const list = document.getElementById('cpdList');
    list.innerHTML = '';
    
    const showIncludedOnly = document.getElementById('cpdFilterCheckbox').checked;
    const selectedYear = document.getElementById('cpdYearFilter').value;
    
    let filteredEvents = [...cpdEvents];
    
    // Filter by year
    if (selectedYear) {
        const [startYear, endYear] = selectedYear.split('-').map(Number);
        filteredEvents = filteredEvents.filter(e => {
            const eventDate = new Date(e.date);
            const eventYear = eventDate.getFullYear();
            const eventMonth = eventDate.getMonth(); // 0-11
            
            // CPD year runs Dec (month 11) to Nov (month 10)
            if (eventMonth === 11) { // December
                return eventYear === startYear;
            } else { // Jan-Nov
                return eventYear === endYear;
            }
        });
    }
    
    // Filter by included status
    if (showIncludedOnly) {
        filteredEvents = filteredEvents.filter(e => e.includedInCPD);
    }
    
    // Sort by date, most recent first
    filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Calculate hours for selected year
    updateCPDHours(selectedYear);
    
    if (filteredEvents.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No activities for this period. Click "+ Add CPD Activity" to get started.</div>';
        return;
    }
    
    filteredEvents.forEach((event) => {
        const index = cpdEvents.indexOf(event);
        
        if (!event.attachments) event.attachments = [];
        if (!event.notes) event.notes = "";
        if (!event.cpdEvidence) event.cpdEvidence = null;
        if (!event.type) event.type = "active";
        if (!event.hours) event.hours = 0;
        if (!event.reflection) event.reflection = "";
        
        const typeLabels = {
            'peer': { text: 'Peer Consultation', color: '#2196f3', bg: '#e3f2fd' },
            'active': { text: 'Active CPD', color: '#ff9800', bg: '#fff3e0' },
            'passive': { text: 'Passive CPD', color: '#9e9e9e', bg: '#f5f5f5' }
        };
        
        const typeInfo = typeLabels[event.type] || typeLabels.active;
        
        const div = document.createElement('div');
        div.className = 'milestone';
        div.innerHTML = `
            <div class="milestone-header">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div class="milestone-title">${event.title}</div>
                        <span style="background: ${typeInfo.bg}; color: ${typeInfo.color}; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${typeInfo.text}</span>
                        <span style="background: #f5f5f5; color: #666; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${event.hours || 0}h</span>
                        ${event.includedInCPD ? '<span style="background: #4caf50; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">‚úì Included</span>' : ''}
                    </div>
                    <div class="milestone-date">${formatDate(event.date)}</div>
                </div>
                <button class="edit-milestone-btn" onclick="openEditCPDModal(${index})">Edit</button>
            </div>
            ${event.description ? `<div class="milestone-description">${event.description}</div>` : ''}
            
            ${event.reflection ? `
                <div style="margin-top: 10px; padding: 10px; background: #fffbf0; border-left: 3px solid #ffc107; border-radius: 4px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">Reflection Journal</div>
                    <div style="font-size: 13px; color: #333; white-space: pre-wrap;">${event.reflection}</div>
                </div>
            ` : ''}
            
            ${event.cpdEvidence ? `
                <div style="margin-top: 10px; padding: 10px; background: #f0f7ff; border-left: 3px solid #2196f3; border-radius: 4px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">CPD Evidence</div>
                    <a href="${event.cpdEvidence.url}" target="_blank" style="color: #2196f3; text-decoration: none; font-size: 13px;">
                        üìÑ ${event.cpdEvidence.name}
                    </a>
                </div>
            ` : ''}
            
            ${event.attachments.length > 0 ? `
                <div class="attachments">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Materials & Notes</div>
                    ${event.attachments.map((att, attIndex) => `
                        <div class="attachment-item">
                            <a href="${att.url}" target="_blank" class="attachment-link" title="${att.url}">
                                üìé ${att.name}
                            </a>
                            <span class="remove-attachment" onclick="removeCPDAttachment(${index}, ${attIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-attachment-btn" onclick="showCPDAttachmentForm(${index})">+ Add Material/Notes</button>
            <div class="attachment-form" id="cpd-attachment-form-${index}">
                <input type="text" id="cpd-attachment-name-${index}" placeholder="File name (e.g., 'Workshop slides')">
                <input type="text" id="cpd-attachment-url-${index}" placeholder="File path (Shift + Right-click ‚Üí Copy as path)">
                <div class="attachment-form-buttons">
                    <button onclick="saveCPDAttachment(${index})">Save</button>
                    <button class="btn-secondary" onclick="hideCPDAttachmentForm(${index})">Cancel</button>
                </div>
            </div>

            ${event.includedInCPD && !event.cpdEvidence ? `
                <button class="add-attachment-btn" onclick="showCPDEvidenceForm(${index})" style="background: #e3f2fd; color: #1976d2;">+ Add CPD Evidence</button>
                <div class="attachment-form" id="cpd-evidence-form-${index}">
                    <input type="text" id="cpd-evidence-name-${index}" placeholder="Evidence name (e.g., 'Certificate of attendance')">
                    <input type="text" id="cpd-evidence-url-${index}" placeholder="File path (Shift + Right-click ‚Üí Copy as path)">
                    <div class="attachment-form-buttons">
                        <button onclick="saveCPDEvidence(${index})">Save</button>
                        <button class="btn-secondary" onclick="hideCPDEvidenceForm(${index})">Cancel</button>
                    </div>
                </div>
            ` : ''}
        `;
        list.appendChild(div);
    });
    
    renderCPDDocuments();
}

function updateCPDHours(selectedYear) {
    if (!selectedYear) return;
    
    const [startYear, endYear] = selectedYear.split('-').map(Number);
    
    // Filter events for this CPD year
    const yearEvents = cpdEvents.filter(e => {
        if (!e.includedInCPD) return false;
        
        const eventDate = new Date(e.date);
        const eventYear = eventDate.getFullYear();
        const eventMonth = eventDate.getMonth();
        
        if (eventMonth === 11) {
            return eventYear === startYear;
        } else {
            return eventYear === endYear;
        }
    });
    
    // Calculate totals
    const totalHours = yearEvents.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
    const peerHours = yearEvents.filter(e => e.type === 'peer').reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
    const activeHours = yearEvents.filter(e => e.type === 'active').reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
    
    // Update displays
    document.getElementById('cpdTotalHours').textContent = totalHours.toFixed(1);
    document.getElementById('cpdPeerHours').textContent = peerHours.toFixed(1);
    document.getElementById('cpdActiveHours').textContent = activeHours.toFixed(1);
    
    // Update progress bars
    document.getElementById('cpdTotalProgress').style.width = Math.min((totalHours / 30) * 100, 100) + '%';
    document.getElementById('cpdPeerProgress').style.width = Math.min((peerHours / 10) * 100, 100) + '%';
    document.getElementById('cpdActiveProgress').style.width = Math.min((activeHours / 10) * 100, 100) + '%';
}

function saveCPD() {
    localStorage.setItem('phdCPD', JSON.stringify(cpdEvents));
}

// Modal functions
function openCPDModal() {
    document.getElementById('cpdTitle').value = '';
    document.getElementById('cpdDate').value = '';
    document.getElementById('cpdDesc').value = '';
    document.getElementById('cpdType').value = 'active';
    document.getElementById('cpdHours').value = '';
    document.getElementById('cpdReflection').value = '';
    document.getElementById('cpdIncluded').checked = true;
    document.getElementById('cpdModal').classList.add('active');
}

function closeCPDModal() {
    document.getElementById('cpdModal').classList.remove('active');
    document.querySelector('#cpdModal h2').textContent = 'Add CPD Activity';
    document.querySelector('#cpdModal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#cpdModal .modal-buttons button:last-child').onclick = addCPD;
    document.getElementById('cpdDeleteBtn').style.display = 'none';
    editingCPDIndex = null;
}

function closeCPDModalOnOutside(event) {
    if (event.target.id === 'cpdModal') closeCPDModal();
}

function addCPD() {
    const title = document.getElementById('cpdTitle').value.trim();
    const date = document.getElementById('cpdDate').value;
    const description = document.getElementById('cpdDesc').value.trim();
    const type = document.getElementById('cpdType').value;
    const hours = parseFloat(document.getElementById('cpdHours').value) || 0;
    const reflection = document.getElementById('cpdReflection').value.trim();
    const includedInCPD = document.getElementById('cpdIncluded').checked;

    if (!title || !date) {
        alert('Please fill in activity title and date');
        return;
    }
    
    if (hours <= 0) {
        alert('Please enter the number of hours for this activity');
        return;
    }

    cpdEvents.push({
        title,
        date,
        description,
        type,
        hours,
        reflection,
        includedInCPD,
        attachments: [],
        notes: "",
        cpdEvidence: null
    });

    saveCPD();
    renderCPD();
    closeCPDModal();
}

let editingCPDIndex = null;

function openEditCPDModal(index) {
    editingCPDIndex = index;
    const event = cpdEvents[index];
    
    document.getElementById('cpdTitle').value = event.title;
    document.getElementById('cpdDate').value = event.date;
    document.getElementById('cpdDesc').value = event.description || '';
    document.getElementById('cpdType').value = event.type || 'active';
    document.getElementById('cpdHours').value = event.hours || '';
    document.getElementById('cpdReflection').value = event.reflection || '';
    document.getElementById('cpdIncluded').checked = event.includedInCPD;
    
    document.querySelector('#cpdModal h2').textContent = 'Edit CPD Activity';
    document.querySelector('#cpdModal .modal-buttons button:last-child').textContent = 'Update';
    document.querySelector('#cpdModal .modal-buttons button:last-child').onclick = updateCPD;
    document.getElementById('cpdDeleteBtn').style.display = 'block';
    
    document.getElementById('cpdModal').classList.add('active');
}

function updateCPD() {
    const title = document.getElementById('cpdTitle').value.trim();
    const date = document.getElementById('cpdDate').value;
    const description = document.getElementById('cpdDesc').value.trim();
    const type = document.getElementById('cpdType').value;
    const hours = parseFloat(document.getElementById('cpdHours').value) || 0;
    const reflection = document.getElementById('cpdReflection').value.trim();
    const includedInCPD = document.getElementById('cpdIncluded').checked;

    if (!title || !date) {
        alert('Please fill in activity title and date');
        return;
    }
    
    if (hours <= 0) {
        alert('Please enter the number of hours for this activity');
        return;
    }

    cpdEvents[editingCPDIndex].title = title;
    cpdEvents[editingCPDIndex].date = date;
    cpdEvents[editingCPDIndex].description = description;
    cpdEvents[editingCPDIndex].type = type;
    cpdEvents[editingCPDIndex].hours = hours;
    cpdEvents[editingCPDIndex].reflection = reflection;
    cpdEvents[editingCPDIndex].includedInCPD = includedInCPD;

    saveCPD();
    renderCPD();
    closeCPDModal();
    
    document.querySelector('#cpdModal h2').textContent = 'Add CPD Activity';
    document.querySelector('#cpdModal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#cpdModal .modal-buttons button:last-child').onclick = addCPD;
    editingCPDIndex = null;
}

function deleteCPDFromModal() {
    if (confirm('Are you sure you want to delete this CPD activity? This cannot be undone.')) {
        cpdEvents.splice(editingCPDIndex, 1);
        saveCPD();
        renderCPD();
        closeCPDModal();
    }
}

// Attachment functions
function showCPDAttachmentForm(index) {
    document.querySelectorAll('.attachment-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`cpd-attachment-form-${index}`).classList.add('active');
}

function hideCPDAttachmentForm(index) {
    document.getElementById(`cpd-attachment-form-${index}`).classList.remove('active');
    document.getElementById(`cpd-attachment-name-${index}`).value = '';
    document.getElementById(`cpd-attachment-url-${index}`).value = '';
}

function saveCPDAttachment(index) {
    const name = document.getElementById(`cpd-attachment-name-${index}`).value.trim();
    const url = document.getElementById(`cpd-attachment-url-${index}`).value.trim();

    if (!name || !url) {
        alert('Please fill in both file name and path');
        return;
    }

    if (!cpdEvents[index].attachments) cpdEvents[index].attachments = [];
    cpdEvents[index].attachments.push({ name, url });
    saveCPD();
    renderCPD();
}

function removeCPDAttachment(eventIndex, attachmentIndex) {
    if (confirm('Remove this attachment?')) {
        cpdEvents[eventIndex].attachments.splice(attachmentIndex, 1);
        saveCPD();
        renderCPD();
    }
}

// CPD Evidence functions
function showCPDEvidenceForm(index) {
    document.querySelectorAll('.attachment-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`cpd-evidence-form-${index}`).classList.add('active');
}

function hideCPDEvidenceForm(index) {
    document.getElementById(`cpd-evidence-form-${index}`).classList.remove('active');
    document.getElementById(`cpd-evidence-name-${index}`).value = '';
    document.getElementById(`cpd-evidence-url-${index}`).value = '';
}

function saveCPDEvidence(index) {
    const name = document.getElementById(`cpd-evidence-name-${index}`).value.trim();
    const url = document.getElementById(`cpd-evidence-url-${index}`).value.trim();

    if (!name || !url) {
        alert('Please fill in both evidence name and file path');
        return;
    }

    cpdEvents[index].cpdEvidence = { name, url };
    saveCPD();
    renderCPD();
}

// CPD Reference Documents functions
function renderCPDDocuments() {
    const list = document.getElementById('cpdDocumentsList');
    
    if (cpdDocuments.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">No reference documents yet</div>';
        return;
    }
    
    list.innerHTML = cpdDocuments.map((doc, index) => `
        <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 6px;">
            <div style="flex: 1;">
                <a href="${doc.path}" target="_blank" style="color: #2196f3; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <span>üìÑ</span>
                    <span style="font-weight: 500;">${doc.name}</span>
                </a>
                <div style="font-size: 12px; color: #999; margin-top: 4px;">Added ${formatDate(doc.dateAdded)}</div>
            </div>
            <button onclick="removeCPDDocument(${index})" style="padding: 6px 12px; background: white; color: #d32f2f; border: 1px solid #d32f2f; border-radius: 4px; cursor: pointer; font-size: 13px;">Remove</button>
        </div>
    `).join('');
}

function addCPDDocument() {
    const name = document.getElementById('cpdDocName').value.trim();
    const path = document.getElementById('cpdDocPath').value.trim();
    
    if (!name || !path) {
        alert('Please fill in both document name and file path/URL');
        return;
    }
    
    cpdDocuments.push({
        name,
        path,
        dateAdded: new Date().toISOString().split('T')[0]
    });
    
    localStorage.setItem('phdCPDDocs', JSON.stringify(cpdDocuments));
    
    document.getElementById('cpdDocName').value = '';
    document.getElementById('cpdDocPath').value = '';
    
    renderCPDDocuments();
}

function removeCPDDocument(index) {
    if (confirm('Remove this document?')) {
        cpdDocuments.splice(index, 1);
        localStorage.setItem('phdCPDDocs', JSON.stringify(cpdDocuments));
        renderCPDDocuments();
    }
}

// Initialize CPD year selector
generateCPDYears();
function dragStartStudy1Subtask(event, itemIndex, subtaskIndex) {
    draggedSubtask = { type: 'study1', itemIndex, subtaskIndex };
    event.dataTransfer.effectAllowed = 'move';
}

function dropStudy1Subtask(event, itemIndex, subtaskIndex) {
    event.preventDefault();
    if (!draggedSubtask || draggedSubtask.type !== 'study1' || draggedSubtask.itemIndex !== itemIndex) return;
    
    const fromIndex = draggedSubtask.subtaskIndex;
    const toIndex = subtaskIndex;
    
    if (fromIndex === toIndex) return;
    
    const subtasks = study1Items[itemIndex].subtasks;
    const [movedItem] = subtasks.splice(fromIndex, 1);
    subtasks.splice(toIndex, 0, movedItem);
    
    saveStudy1();
    renderStudy1();
    draggedSubtask = null;
}

function updateStudy1SubtaskText(itemIndex, subtaskIndex, newText) {
    const trimmed = newText.trim();
    if (trimmed && trimmed !== study1Items[itemIndex].subtasks[subtaskIndex].text) {
        study1Items[itemIndex].subtasks[subtaskIndex].text = trimmed;
        saveStudy1();
    }
    renderStudy1();
}


function dragStartStudy2Subtask(event, itemIndex, subtaskIndex) {
    draggedSubtask = { type: 'study2', itemIndex, subtaskIndex };
    event.dataTransfer.effectAllowed = 'move';
}

function dropStudy2Subtask(event, itemIndex, subtaskIndex) {
    event.preventDefault();
    if (!draggedSubtask || draggedSubtask.type !== 'study2' || draggedSubtask.itemIndex !== itemIndex) return;
    
    const fromIndex = draggedSubtask.subtaskIndex;
    const toIndex = subtaskIndex;
    
    if (fromIndex === toIndex) return;
    
    const subtasks = study2Items[itemIndex].subtasks;
    const [movedItem] = subtasks.splice(fromIndex, 1);
    subtasks.splice(toIndex, 0, movedItem);
    
    saveStudy2();
    renderStudy2();
    draggedSubtask = null;
}

function updateStudy2SubtaskText(itemIndex, subtaskIndex, newText) {
    const trimmed = newText.trim();
    if (trimmed && trimmed !== study2Items[itemIndex].subtasks[subtaskIndex].text) {
        study2Items[itemIndex].subtasks[subtaskIndex].text = trimmed;
        saveStudy2();
    }
    renderStudy2();
}


function dragStartStudy3Subtask(event, itemIndex, subtaskIndex) {
    draggedSubtask = { type: 'study3', itemIndex, subtaskIndex };
    event.dataTransfer.effectAllowed = 'move';
}

function dropStudy3Subtask(event, itemIndex, subtaskIndex) {
    event.preventDefault();
    if (!draggedSubtask || draggedSubtask.type !== 'study3' || draggedSubtask.itemIndex !== itemIndex) return;
    
    const fromIndex = draggedSubtask.subtaskIndex;
    const toIndex = subtaskIndex;
    
    if (fromIndex === toIndex) return;
    
    const subtasks = study3Items[itemIndex].subtasks;
    const [movedItem] = subtasks.splice(fromIndex, 1);
    subtasks.splice(toIndex, 0, movedItem);
    
    saveStudy3();
    renderStudy3();
    draggedSubtask = null;
}

function updateStudy3SubtaskText(itemIndex, subtaskIndex, newText) {
    const trimmed = newText.trim();
    if (trimmed && trimmed !== study3Items[itemIndex].subtasks[subtaskIndex].text) {
        study3Items[itemIndex].subtasks[subtaskIndex].text = trimmed;
        saveStudy3();
    }
    renderStudy3();
}


function dragStartOtherChaptersSubtask(event, itemIndex, subtaskIndex) {
    draggedSubtask = { type: 'otherchapters', itemIndex, subtaskIndex };
    event.dataTransfer.effectAllowed = 'move';
}

function dropOtherChaptersSubtask(event, itemIndex, subtaskIndex) {
    event.preventDefault();
    if (!draggedSubtask || draggedSubtask.type !== 'otherchapters' || draggedSubtask.itemIndex !== itemIndex) return;
    
    const fromIndex = draggedSubtask.subtaskIndex;
    const toIndex = subtaskIndex;
    
    if (fromIndex === toIndex) return;
    
    const subtasks = otherChaptersItems[itemIndex].subtasks;
    const [movedItem] = subtasks.splice(fromIndex, 1);
    subtasks.splice(toIndex, 0, movedItem);
    
    saveOtherChapters();
    renderOtherChapters();
    draggedSubtask = null;
}

function updateOtherChaptersSubtaskText(itemIndex, subtaskIndex, newText) {
    const trimmed = newText.trim();
    if (trimmed && trimmed !== otherChaptersItems[itemIndex].subtasks[subtaskIndex].text) {
        otherChaptersItems[itemIndex].subtasks[subtaskIndex].text = trimmed;
        saveOtherChapters();
    }
    renderOtherChapters();
}


        // Todo attachment functions
        function showTodoAttachmentForm(index) {
            document.querySelectorAll('.attachment-form').forEach(form => form.classList.remove('active'));
            document.getElementById(`todo-attachment-form-${index}`).classList.add('active');
        }

        function hideTodoAttachmentForm(index) {
            document.getElementById(`todo-attachment-form-${index}`).classList.remove('active');
            document.getElementById(`todo-attachment-name-${index}`).value = '';
            document.getElementById(`todo-attachment-url-${index}`).value = '';
        }

        function saveTodoAttachment(index) {
            const name = document.getElementById(`todo-attachment-name-${index}`).value.trim();
            const url = document.getElementById(`todo-attachment-url-${index}`).value.trim();

            if (!name || !url) {
                alert('Please fill in both link name and path/URL');
                return;
            }

            if (!todos[index].attachments) todos[index].attachments = [];
            todos[index].attachments.push({ name, url });
            saveTodos();
            renderTodos();
        }

        function removeTodoAttachment(todoIndex, attachmentIndex) {
            if (confirm('Remove this attachment?')) {
                todos[todoIndex].attachments.splice(attachmentIndex, 1);
                saveTodos();
                renderTodos();
            }
        }

        // Todo notes functions
        function showTodoNotesForm(index) {
            document.getElementById(`todo-notes-form-${index}`).classList.add('active');
        }

        function hideTodoNotesForm(index) {
            document.getElementById(`todo-notes-form-${index}`).classList.remove('active');
        }

        function saveTodoNotes(index) {
            const notes = document.getElementById(`todo-notes-textarea-${index}`).value.trim();
            todos[index].notes = notes;
            saveTodos();
            renderTodos();
        }

        // Todo modal functions
        function openTodoModal() {
            document.getElementById('todoTitle').value = '';
            document.getElementById('todoDate').value = '';
            document.getElementById('todoDesc').value = '';
            document.getElementById('todoPriority').value = 'medium';
            document.getElementById('todoModal').classList.add('active');
        }

        function closeTodoModal() {
            document.getElementById('todoModal').classList.remove('active');
            // Reset modal to add mode
            document.querySelector('#todoModal h2').textContent = 'Add To Do';
            document.querySelector('#todoModal .modal-buttons button:last-child').textContent = 'Add';
            document.querySelector('#todoModal .modal-buttons button:last-child').onclick = addTodo;
            document.getElementById('todoDeleteBtn').style.display = 'none';
            document.getElementById('todoConvertSelect').style.display = 'none';
            editingTodoIndex = null;
        }

        function closeTodoModalOnOutside(event) {
            if (event.target.id === 'todoModal') {
                closeTodoModal();
            }
        }

        function addTodo() {
            const title = document.getElementById('todoTitle').value.trim();
            const date = document.getElementById('todoDate').value;
            const description = document.getElementById('todoDesc').value.trim();
            const priority = document.getElementById('todoPriority').value;

            if (!title) {
                alert('Please fill in a title');
                return;
            }

            todos.push({
                title,
                date: date || null,
                description,
                completed: false,
                attachments: [],
                notes: "",
                subtasks: [],
                priority: priority
            });

            saveTodos();
            renderTodos();
            closeTodoModal();
        }

        let editingTodoIndex = null;

        function openEditTodoModal(index) {
            editingTodoIndex = index;
            const todo = todos[index];
            
            document.getElementById('todoTitle').value = todo.title;
            document.getElementById('todoDate').value = todo.date || '';
            document.getElementById('todoDesc').value = todo.description || '';
            document.getElementById('todoPriority').value = todo.priority || 'medium';
            
            document.querySelector('#todoModal h2').textContent = 'Edit To Do';
            document.querySelector('#todoModal .modal-buttons button:last-child').textContent = 'Update';
            document.querySelector('#todoModal .modal-buttons button:last-child').onclick = updateTodo;
            
            // Show delete and convert dropdown
            document.getElementById('todoDeleteBtn').style.display = 'block';
            document.getElementById('todoConvertSelect').style.display = 'inline-block';
            document.getElementById('todoConvertSelect').value = '';
            
            document.getElementById('todoModal').classList.add('active');
        }

        function deleteTodoFromModal() {
            if (confirm('Are you sure you want to delete this to do? This cannot be undone.')) {
                todos.splice(editingTodoIndex, 1);
                saveTodos();
                renderTodos();
                closeTodoModal();
            }
        }

        function convertTodo(targetType) {
            if (!targetType) return;
            const todo = todos[editingTodoIndex];
            
            // Check if converting to milestone and needs a date
            if (targetType === 'milestone' && !todo.date) {
                alert('This to do needs a due date before converting to a milestone. Please add a date first.');
                document.getElementById('todoConvertSelect').value = '';
                return;
            }
            
            const targetMap = {
                'milestone': { array: milestones, name: 'CoC Milestone', storage: saveMilestones, render: renderMilestones },
                'study1': { array: study1Items, name: 'Study 1', storage: saveStudy1, render: renderStudy1 },
                'study2': { array: study2Items, name: 'Study 2', storage: saveStudy2, render: renderStudy2 },
                'study3': { array: study3Items, name: 'Study 3', storage: saveStudy3, render: renderStudy3 },
                'otherchapters': { array: otherChaptersItems, name: 'Other Chapters', storage: saveOtherChapters, render: renderOtherChapters }
            };
            
            const target = targetMap[targetType];
            if (!target) return;
            
            if (confirm(`Convert this to do to ${target.name}?`)) {
                target.array.push({
                    title: todo.title,
                    date: todo.date,
                    description: todo.description,
                    completed: todo.completed,
                    attachments: todo.attachments || [],
                    notes: todo.notes || '',
                    subtasks: todo.subtasks || [],
                    priority: todo.priority || 'medium'
                });
                
                todos.splice(editingTodoIndex, 1);
                saveTodos();
                target.storage();
                renderTodos();
                target.render();
                closeTodoModal();
                alert(`Converted to ${target.name}!`);
            }
        }

// Convert function for Study 1
function convertStudy1(targetType) {
    if (!targetType) return;
    const item = study1Items[editingStudy1Index];
    
    if (targetType === 'milestone' && !item.date) {
        alert('This item needs a due date before converting to a milestone. Please add a date first.');
        document.getElementById('study1ConvertSelect').value = '';
        return;
    }
    
    const targetMap = {
        'milestone': { array: milestones, name: 'CoC Milestone', storage: saveMilestones, render: renderMilestones },
        'todo': { array: todos, name: 'To Do', storage: saveTodos, render: renderTodos },
        'study1': { array: study1Items, name: 'Study 1', storage: saveStudy1, render: renderStudy1 },
        'study2': { array: study2Items, name: 'Study 2', storage: saveStudy2, render: renderStudy2 },
        'study3': { array: study3Items, name: 'Study 3', storage: saveStudy3, render: renderStudy3 },
        'otherchapters': { array: otherChaptersItems, name: 'Other Chapters', storage: saveOtherChapters, render: renderOtherChapters }
    };
    
    const target = targetMap[targetType];
    if (!target) return;
    
    if (confirm(`Convert this item to ${target.name}?`)) {
        target.array.push({
            title: item.title,
            date: item.date,
            description: item.description,
            completed: item.completed,
            attachments: item.attachments || [],
            notes: item.notes || '',
            subtasks: item.subtasks || [],
            priority: item.priority || 'medium'
        });
        
        study1Items.splice(editingStudy1Index, 1);
        saveStudy1();
        target.storage();
        renderStudy1();
        target.render();
        closeStudy1Modal();
        alert(`Converted to ${target.name}!`);
    }
}

// Update openEditStudy1Modal to show convert dropdown
const original_openEditStudy1Modal = openEditStudy1Modal;
openEditStudy1Modal = function(index) {
    original_openEditStudy1Modal(index);
    document.getElementById('study1ConvertSelect').style.display = 'inline-block';
    document.getElementById('study1ConvertSelect').value = '';
};

// Update closeStudy1Modal to hide convert dropdown
const original_closeStudy1Modal = closeStudy1Modal;
closeStudy1Modal = function() {
    original_closeStudy1Modal();
    document.getElementById('study1ConvertSelect').style.display = 'none';
};


// Convert function for Study 2
function convertStudy2(targetType) {
    if (!targetType) return;
    const item = study2Items[editingStudy2Index];
    
    if (targetType === 'milestone' && !item.date) {
        alert('This item needs a due date before converting to a milestone. Please add a date first.');
        document.getElementById('study2ConvertSelect').value = '';
        return;
    }
    
    const targetMap = {
        'milestone': { array: milestones, name: 'CoC Milestone', storage: saveMilestones, render: renderMilestones },
        'todo': { array: todos, name: 'To Do', storage: saveTodos, render: renderTodos },
        'study1': { array: study1Items, name: 'Study 1', storage: saveStudy1, render: renderStudy1 },
        'study2': { array: study2Items, name: 'Study 2', storage: saveStudy2, render: renderStudy2 },
        'study3': { array: study3Items, name: 'Study 3', storage: saveStudy3, render: renderStudy3 },
        'otherchapters': { array: otherChaptersItems, name: 'Other Chapters', storage: saveOtherChapters, render: renderOtherChapters }
    };
    
    const target = targetMap[targetType];
    if (!target) return;
    
    if (confirm(`Convert this item to ${target.name}?`)) {
        target.array.push({
            title: item.title,
            date: item.date,
            description: item.description,
            completed: item.completed,
            attachments: item.attachments || [],
            notes: item.notes || '',
            subtasks: item.subtasks || [],
            priority: item.priority || 'medium'
        });
        
        study2Items.splice(editingStudy2Index, 1);
        saveStudy2();
        target.storage();
        renderStudy2();
        target.render();
        closeStudy2Modal();
        alert(`Converted to ${target.name}!`);
    }
}

// Update openEditStudy2Modal to show convert dropdown
const original_openEditStudy2Modal = openEditStudy2Modal;
openEditStudy2Modal = function(index) {
    original_openEditStudy2Modal(index);
    document.getElementById('study2ConvertSelect').style.display = 'inline-block';
    document.getElementById('study2ConvertSelect').value = '';
};

// Update closeStudy2Modal to hide convert dropdown
const original_closeStudy2Modal = closeStudy2Modal;
closeStudy2Modal = function() {
    original_closeStudy2Modal();
    document.getElementById('study2ConvertSelect').style.display = 'none';
};


// Convert function for Study 3
function convertStudy3(targetType) {
    if (!targetType) return;
    const item = study3Items[editingStudy3Index];
    
    if (targetType === 'milestone' && !item.date) {
        alert('This item needs a due date before converting to a milestone. Please add a date first.');
        document.getElementById('study3ConvertSelect').value = '';
        return;
    }
    
    const targetMap = {
        'milestone': { array: milestones, name: 'CoC Milestone', storage: saveMilestones, render: renderMilestones },
        'todo': { array: todos, name: 'To Do', storage: saveTodos, render: renderTodos },
        'study1': { array: study1Items, name: 'Study 1', storage: saveStudy1, render: renderStudy1 },
        'study2': { array: study2Items, name: 'Study 2', storage: saveStudy2, render: renderStudy2 },
        'study3': { array: study3Items, name: 'Study 3', storage: saveStudy3, render: renderStudy3 },
        'otherchapters': { array: otherChaptersItems, name: 'Other Chapters', storage: saveOtherChapters, render: renderOtherChapters }
    };
    
    const target = targetMap[targetType];
    if (!target) return;
    
    if (confirm(`Convert this item to ${target.name}?`)) {
        target.array.push({
            title: item.title,
            date: item.date,
            description: item.description,
            completed: item.completed,
            attachments: item.attachments || [],
            notes: item.notes || '',
            subtasks: item.subtasks || [],
            priority: item.priority || 'medium'
        });
        
        study3Items.splice(editingStudy3Index, 1);
        saveStudy3();
        target.storage();
        renderStudy3();
        target.render();
        closeStudy3Modal();
        alert(`Converted to ${target.name}!`);
    }
}

// Update openEditStudy3Modal to show convert dropdown
const original_openEditStudy3Modal = openEditStudy3Modal;
openEditStudy3Modal = function(index) {
    original_openEditStudy3Modal(index);
    document.getElementById('study3ConvertSelect').style.display = 'inline-block';
    document.getElementById('study3ConvertSelect').value = '';
};

// Update closeStudy3Modal to hide convert dropdown
const original_closeStudy3Modal = closeStudy3Modal;
closeStudy3Modal = function() {
    original_closeStudy3Modal();
    document.getElementById('study3ConvertSelect').style.display = 'none';
};


// Convert function for Other Chapters
function convertOtherChapters(targetType) {
    if (!targetType) return;
    const item = otherChaptersItems[editingOtherChaptersIndex];
    
    if (targetType === 'milestone' && !item.date) {
        alert('This item needs a due date before converting to a milestone. Please add a date first.');
        document.getElementById('otherchaptersConvertSelect').value = '';
        return;
    }
    
    const targetMap = {
        'milestone': { array: milestones, name: 'CoC Milestone', storage: saveMilestones, render: renderMilestones },
        'todo': { array: todos, name: 'To Do', storage: saveTodos, render: renderTodos },
        'study1': { array: study1Items, name: 'Study 1', storage: saveStudy1, render: renderStudy1 },
        'study2': { array: study2Items, name: 'Study 2', storage: saveStudy2, render: renderStudy2 },
        'study3': { array: study3Items, name: 'Study 3', storage: saveStudy3, render: renderStudy3 },
        'otherchapters': { array: otherChaptersItems, name: 'Other Chapters', storage: saveOtherChapters, render: renderOtherChapters }
    };
    
    const target = targetMap[targetType];
    if (!target) return;
    
    if (confirm(`Convert this item to ${target.name}?`)) {
        target.array.push({
            title: item.title,
            date: item.date,
            description: item.description,
            completed: item.completed,
            attachments: item.attachments || [],
            notes: item.notes || '',
            subtasks: item.subtasks || [],
            priority: item.priority || 'medium'
        });
        
        otherChaptersItems.splice(editingOtherChaptersIndex, 1);
        saveOtherChapters();
        target.storage();
        renderOtherChapters();
        target.render();
        closeOtherChaptersModal();
        alert(`Converted to ${target.name}!`);
    }
}

// Update openEditOtherChaptersModal to show convert dropdown
const original_openEditOtherChaptersModal = openEditOtherChaptersModal;
openEditOtherChaptersModal = function(index) {
    original_openEditOtherChaptersModal(index);
    document.getElementById('otherchaptersConvertSelect').style.display = 'inline-block';
    document.getElementById('otherchaptersConvertSelect').value = '';
};

// Update closeOtherChaptersModal to hide convert dropdown
const original_closeOtherChaptersModal = closeOtherChaptersModal;
closeOtherChaptersModal = function() {
    original_closeOtherChaptersModal();
    document.getElementById('otherchaptersConvertSelect').style.display = 'none';
};


// ========== Study 1 Functions ==========
function renderStudy1() {
    const list = document.getElementById('study1List');
    list.innerHTML = '';
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const sortedStudy1 = [...study1Items].sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        if (!a.date && b.date) return 1;
        if (a.date && !b.date) return -1;
        if (!a.date && !b.date) return 0;
        return new Date(a.date) - new Date(b.date);
    });

    sortedStudy1.forEach((item) => {
        const index = study1Items.indexOf(item);
        const dueDate = item.date ? new Date(item.date) : null;
        const isOverdue = !item.completed && dueDate && dueDate < today;
        
        if (!item.attachments) item.attachments = [];
        if (!item.notes) item.notes = "";
        if (!item.subtasks) item.subtasks = [];
        if (!item.priority) item.priority = "medium";
        
        const div = document.createElement('div');
        div.className = 'milestone' + (item.completed ? ' completed' : '');
        div.innerHTML = `
            <div class="milestone-header">
                <input type="checkbox" class="checkbox" ${item.completed ? 'checked' : ''} 
                       onchange="toggleStudy1(${index})">
                <div style="flex: 1;">
                    <div class="milestone-title">${item.title}</div>
                    ${item.date ? `<div class="milestone-date ${isOverdue ? 'overdue' : ''}">
                        ${formatDate(item.date)} ${isOverdue ? '(overdue)' : ''}
                    </div>` : '<div class="milestone-date" style="color: #999;">No due date</div>'}
                </div>
                <div class="priority-indicator">
                    <div class="priority-dot ${item.completed ? 'done' : (item.priority || 'medium')}" 
                         onclick="toggleStudy1PriorityMenu(${index}, event)" 
                         title="${item.completed ? 'Done' : ((item.priority || 'medium').charAt(0).toUpperCase() + (item.priority || 'medium').slice(1) + ' priority')}">
                    </div>
                    <div class="priority-menu" id="study1-priority-menu-${index}">
                        <div class="priority-option" onclick="setStudy1Priority(${index}, 'high')">
                            <div class="priority-option-dot high"></div>
                            <span>High</span>
                        </div>
                        <div class="priority-option" onclick="setStudy1Priority(${index}, 'medium')">
                            <div class="priority-option-dot medium"></div>
                            <span>Medium</span>
                        </div>
                        <div class="priority-option" onclick="setStudy1Priority(${index}, 'low')">
                            <div class="priority-option-dot low"></div>
                            <span>Low</span>
                        </div>
                    </div>
                </div>
                <button class="edit-milestone-btn" onclick="openEditStudy1Modal(${index})">Edit</button>
            </div>
            ${item.description ? `<div class="milestone-description">${item.description}</div>` : ''}
            
            ${item.subtasks.length > 0 ? `
                <div class="subtasks-section">
                    ${item.subtasks.map((subtask, subIndex) => `
                        <div class="subtask-item">
                            <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                   onchange="toggleStudy1Subtask(${index}, ${subIndex})">
                                    <span class="subtask-text ${subtask.completed ? 'completed' : ''}" 
                                          contenteditable="true" 
                                          onblur="updateStudy1SubtaskText(${index}, ${subIndex}, this.textContent)"
                                          onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${subtask.text}</span>
                            <span class="remove-subtask" onclick="removeStudy1Subtask(${index}, ${subIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-subtask-btn" onclick="showStudy1SubtaskForm(${index})">+ Add Subtask</button>
            <div class="subtask-form" id="study1-subtask-form-${index}">
                <input type="text" id="study1-subtask-input-${index}" placeholder="Enter subtask...">
                <button onclick="saveStudy1Subtask(${index})">Add</button>
                <button class="btn-secondary" onclick="hideStudy1SubtaskForm(${index})">Cancel</button>
            </div>

            ${item.attachments.length > 0 ? `
                <div class="attachments">
                    ${item.attachments.map((att, attIndex) => `
                        <div class="attachment-item">
                            <a href="${att.url}" target="_blank" class="attachment-link" title="${att.url}">
                                üìé ${att.name}
                            </a>
                            <span class="remove-attachment" onclick="removeStudy1Attachment(${index}, ${attIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-attachment-btn" onclick="showStudy1AttachmentForm(${index})">+ Add Link</button>
            <div class="attachment-form" id="study1-attachment-form-${index}">
                <input type="text" id="study1-attachment-name-${index}" placeholder="Link name">
                <input type="text" id="study1-attachment-url-${index}" placeholder="Web link OR file path">
                <div class="attachment-form-buttons">
                    <button onclick="saveStudy1Attachment(${index})">Save</button>
                    <button class="btn-secondary" onclick="hideStudy1AttachmentForm(${index})">Cancel</button>
                </div>
            </div>

            <div class="milestone-notes">
                ${item.notes ? `<div class="notes-display">${item.notes}</div>` : ''}
                <button class="add-notes-btn" onclick="showStudy1NotesForm(${index})">${item.notes ? 'Edit Notes' : '+ Add Notes'}</button>
                <div class="notes-form" id="study1-notes-form-${index}">
                    <textarea id="study1-notes-textarea-${index}" placeholder="Add notes...">${item.notes || ''}</textarea>
                    <div class="notes-buttons">
                        <button onclick="saveStudy1Notes(${index})">Save</button>
                        <button class="btn-secondary" onclick="hideStudy1NotesForm(${index})">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        list.appendChild(div);
    });

    updateStudy1Stats();
}

function updateStudy1Stats() {
    const completed = study1Items.filter(t => t.completed).length;
    const total = study1Items.length;
    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
    document.getElementById('study1CompletedCount').textContent = completed;
    document.getElementById('study1RemainingCount').textContent = total - completed;
    document.getElementById('study1ProgressPercent').textContent = percent + '%';
    document.getElementById('study1ProgressBar').style.width = percent + '%';
}

function saveStudy1() {
    localStorage.setItem('phdStudy1', JSON.stringify(study1Items));
    renderCalendar();
}

function toggleStudy1(index) {
    const wasCompleted = study1Items[index].completed;
    study1Items[index].completed = !wasCompleted;
    if (wasCompleted && !study1Items[index].completed) {
        study1Items[index].priority = 'medium';
    }
    saveStudy1();
    renderStudy1();
}

function toggleStudy1PriorityMenu(index, event) {
    event.stopPropagation();
    if (study1Items[index].completed) return;
    const menu = document.getElementById(`study1-priority-menu-${index}`);
    document.querySelectorAll('.priority-menu').forEach(m => {
        if (m !== menu) m.classList.remove('active');
    });
    menu.classList.toggle('active');
}

function setStudy1Priority(index, priority) {
    study1Items[index].priority = priority;
    saveStudy1();
    renderStudy1();
}

function showStudy1SubtaskForm(index) {
    document.querySelectorAll('.subtask-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`study1-subtask-form-${index}`).classList.add('active');
    document.getElementById(`study1-subtask-input-${index}`).focus();
}

function hideStudy1SubtaskForm(index) {
    document.getElementById(`study1-subtask-form-${index}`).classList.remove('active');
    document.getElementById(`study1-subtask-input-${index}`).value = '';
}

function saveStudy1Subtask(index) {
    const text = document.getElementById(`study1-subtask-input-${index}`).value.trim();
    if (!text) { alert('Please enter a subtask'); return; }
    if (!study1Items[index].subtasks) study1Items[index].subtasks = [];
    study1Items[index].subtasks.push({ text: text, completed: false });
    saveStudy1();
    renderStudy1();
}

function toggleStudy1Subtask(itemIndex, subtaskIndex) {
    study1Items[itemIndex].subtasks[subtaskIndex].completed = !study1Items[itemIndex].subtasks[subtaskIndex].completed;
    saveStudy1();
    renderStudy1();
}

function removeStudy1Subtask(itemIndex, subtaskIndex) {
    if (confirm('Remove this subtask?')) {
        study1Items[itemIndex].subtasks.splice(subtaskIndex, 1);
        saveStudy1();
        renderStudy1();
    }
}

function showStudy1AttachmentForm(index) {
    document.querySelectorAll('.attachment-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`study1-attachment-form-${index}`).classList.add('active');
}

function hideStudy1AttachmentForm(index) {
    document.getElementById(`study1-attachment-form-${index}`).classList.remove('active');
    document.getElementById(`study1-attachment-name-${index}`).value = '';
    document.getElementById(`study1-attachment-url-${index}`).value = '';
}

function saveStudy1Attachment(index) {
    const name = document.getElementById(`study1-attachment-name-${index}`).value.trim();
    const url = document.getElementById(`study1-attachment-url-${index}`).value.trim();
    if (!name || !url) { alert('Please fill in both fields'); return; }
    if (!study1Items[index].attachments) study1Items[index].attachments = [];
    study1Items[index].attachments.push({ name, url });
    saveStudy1();
    renderStudy1();
}

function removeStudy1Attachment(itemIndex, attachmentIndex) {
    if (confirm('Remove this attachment?')) {
        study1Items[itemIndex].attachments.splice(attachmentIndex, 1);
        saveStudy1();
        renderStudy1();
    }
}

function showStudy1NotesForm(index) {
    document.getElementById(`study1-notes-form-${index}`).classList.add('active');
}

function hideStudy1NotesForm(index) {
    document.getElementById(`study1-notes-form-${index}`).classList.remove('active');
}

function saveStudy1Notes(index) {
    const notes = document.getElementById(`study1-notes-textarea-${index}`).value.trim();
    study1Items[index].notes = notes;
    saveStudy1();
    renderStudy1();
}

let editingStudy1Index = null;

function openStudy1Modal() {
    document.getElementById('study1Title').value = '';
    document.getElementById('study1Date').value = '';
    document.getElementById('study1Desc').value = '';
    document.getElementById('study1Priority').value = 'medium';
    document.getElementById('study1Modal').classList.add('active');
}

function closeStudy1Modal() {
    document.getElementById('study1Modal').classList.remove('active');
    document.querySelector('#study1Modal h2').textContent = 'Add Study 1 Item';
    document.querySelector('#study1Modal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#study1Modal .modal-buttons button:last-child').onclick = addStudy1;
    document.getElementById('study1DeleteBtn').style.display = 'none';
    editingStudy1Index = null;
}

function closeStudy1ModalOnOutside(event) {
    if (event.target.id === 'study1Modal') closeStudy1Modal();
}

function addStudy1() {
    const title = document.getElementById('study1Title').value.trim();
    const date = document.getElementById('study1Date').value;
    const description = document.getElementById('study1Desc').value.trim();
    const priority = document.getElementById('study1Priority').value;
    if (!title) { alert('Please fill in a title'); return; }
    study1Items.push({
        title, date: date || null, description,
        completed: false, attachments: [], notes: "", subtasks: [], priority
    });
    saveStudy1();
    renderStudy1();
    closeStudy1Modal();
}

function openEditStudy1Modal(index) {
    editingStudy1Index = index;
    const item = study1Items[index];
    document.getElementById('study1Title').value = item.title;
    document.getElementById('study1Date').value = item.date || '';
    document.getElementById('study1Desc').value = item.description || '';
    document.getElementById('study1Priority').value = item.priority || 'medium';
    document.querySelector('#study1Modal h2').textContent = 'Edit Study 1 Item';
    document.querySelector('#study1Modal .modal-buttons button:last-child').textContent = 'Update';
    document.querySelector('#study1Modal .modal-buttons button:last-child').onclick = updateStudy1;
    document.getElementById('study1DeleteBtn').style.display = 'block';
    document.getElementById('study1Modal').classList.add('active');
}

function updateStudy1() {
    const title = document.getElementById('study1Title').value.trim();
    const date = document.getElementById('study1Date').value;
    const description = document.getElementById('study1Desc').value.trim();
    const priority = document.getElementById('study1Priority').value;
    if (!title) { alert('Please fill in a title'); return; }
    study1Items[editingStudy1Index].title = title;
    study1Items[editingStudy1Index].date = date || null;
    study1Items[editingStudy1Index].description = description;
    study1Items[editingStudy1Index].priority = priority;
    saveStudy1();
    renderStudy1();
    closeStudy1Modal();
    document.querySelector('#study1Modal h2').textContent = 'Add Study 1 Item';
    document.querySelector('#study1Modal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#study1Modal .modal-buttons button:last-child').onclick = addStudy1;
    editingStudy1Index = null;
}

function deleteStudy1FromModal() {
    if (confirm('Are you sure you want to delete this item? This cannot be undone.')) {
        study1Items.splice(editingStudy1Index, 1);
        saveStudy1();
        renderStudy1();
        closeStudy1Modal();
    }
}

function goToStudy1(index) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab')[3].classList.add('active');
    document.getElementById('study1').classList.add('active');
    setTimeout(() => {
        const elements = document.querySelectorAll('#study1List .milestone');
        const sorted = [...study1Items].sort((a, b) => {
            if (a.completed !== b.completed) return a.completed ? 1 : -1;
            if (!a.date && b.date) return 1;
            if (a.date && !b.date) return -1;
            if (!a.date && !b.date) return 0;
            return new Date(a.date) - new Date(b.date);
        });
        const target = study1Items[index];
        const sortedIndex = sorted.indexOf(target);
        if (elements[sortedIndex]) {
            elements[sortedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            elements[sortedIndex].style.backgroundColor = '#fff9c4';
            setTimeout(() => { elements[sortedIndex].style.backgroundColor = ''; }, 1500);
        }
    }, 100);
}

// ========== Study 2 Functions ==========
function renderStudy2() {
    const list = document.getElementById('study2List');
    list.innerHTML = '';
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const sortedStudy2 = [...study2Items].sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        if (!a.date && b.date) return 1;
        if (a.date && !b.date) return -1;
        if (!a.date && !b.date) return 0;
        return new Date(a.date) - new Date(b.date);
    });

    sortedStudy2.forEach((item) => {
        const index = study2Items.indexOf(item);
        const dueDate = item.date ? new Date(item.date) : null;
        const isOverdue = !item.completed && dueDate && dueDate < today;
        
        if (!item.attachments) item.attachments = [];
        if (!item.notes) item.notes = "";
        if (!item.subtasks) item.subtasks = [];
        if (!item.priority) item.priority = "medium";
        
        const div = document.createElement('div');
        div.className = 'milestone' + (item.completed ? ' completed' : '');
        div.innerHTML = `
            <div class="milestone-header">
                <input type="checkbox" class="checkbox" ${item.completed ? 'checked' : ''} 
                       onchange="toggleStudy2(${index})">
                <div style="flex: 1;">
                    <div class="milestone-title">${item.title}</div>
                    ${item.date ? `<div class="milestone-date ${isOverdue ? 'overdue' : ''}">
                        ${formatDate(item.date)} ${isOverdue ? '(overdue)' : ''}
                    </div>` : '<div class="milestone-date" style="color: #999;">No due date</div>'}
                </div>
                <div class="priority-indicator">
                    <div class="priority-dot ${item.completed ? 'done' : (item.priority || 'medium')}" 
                         onclick="toggleStudy2PriorityMenu(${index}, event)" 
                         title="${item.completed ? 'Done' : ((item.priority || 'medium').charAt(0).toUpperCase() + (item.priority || 'medium').slice(1) + ' priority')}">
                    </div>
                    <div class="priority-menu" id="study2-priority-menu-${index}">
                        <div class="priority-option" onclick="setStudy2Priority(${index}, 'high')">
                            <div class="priority-option-dot high"></div>
                            <span>High</span>
                        </div>
                        <div class="priority-option" onclick="setStudy2Priority(${index}, 'medium')">
                            <div class="priority-option-dot medium"></div>
                            <span>Medium</span>
                        </div>
                        <div class="priority-option" onclick="setStudy2Priority(${index}, 'low')">
                            <div class="priority-option-dot low"></div>
                            <span>Low</span>
                        </div>
                    </div>
                </div>
                <button class="edit-milestone-btn" onclick="openEditStudy2Modal(${index})">Edit</button>
            </div>
            ${item.description ? `<div class="milestone-description">${item.description}</div>` : ''}
            
            ${item.subtasks.length > 0 ? `
                <div class="subtasks-section">
                    ${item.subtasks.map((subtask, subIndex) => `
                        <div class="subtask-item">
                            <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                   onchange="toggleStudy2Subtask(${index}, ${subIndex})">
                                    <span class="subtask-text ${subtask.completed ? 'completed' : ''}" 
                                          contenteditable="true" 
                                          onblur="updateStudy2SubtaskText(${index}, ${subIndex}, this.textContent)"
                                          onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${subtask.text}</span>
                            <span class="remove-subtask" onclick="removeStudy2Subtask(${index}, ${subIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-subtask-btn" onclick="showStudy2SubtaskForm(${index})">+ Add Subtask</button>
            <div class="subtask-form" id="study2-subtask-form-${index}">
                <input type="text" id="study2-subtask-input-${index}" placeholder="Enter subtask...">
                <button onclick="saveStudy2Subtask(${index})">Add</button>
                <button class="btn-secondary" onclick="hideStudy2SubtaskForm(${index})">Cancel</button>
            </div>

            ${item.attachments.length > 0 ? `
                <div class="attachments">
                    ${item.attachments.map((att, attIndex) => `
                        <div class="attachment-item">
                            <a href="${att.url}" target="_blank" class="attachment-link" title="${att.url}">
                                üìé ${att.name}
                            </a>
                            <span class="remove-attachment" onclick="removeStudy2Attachment(${index}, ${attIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-attachment-btn" onclick="showStudy2AttachmentForm(${index})">+ Add Link</button>
            <div class="attachment-form" id="study2-attachment-form-${index}">
                <input type="text" id="study2-attachment-name-${index}" placeholder="Link name">
                <input type="text" id="study2-attachment-url-${index}" placeholder="Web link OR file path">
                <div class="attachment-form-buttons">
                    <button onclick="saveStudy2Attachment(${index})">Save</button>
                    <button class="btn-secondary" onclick="hideStudy2AttachmentForm(${index})">Cancel</button>
                </div>
            </div>

            <div class="milestone-notes">
                ${item.notes ? `<div class="notes-display">${item.notes}</div>` : ''}
                <button class="add-notes-btn" onclick="showStudy2NotesForm(${index})">${item.notes ? 'Edit Notes' : '+ Add Notes'}</button>
                <div class="notes-form" id="study2-notes-form-${index}">
                    <textarea id="study2-notes-textarea-${index}" placeholder="Add notes...">${item.notes || ''}</textarea>
                    <div class="notes-buttons">
                        <button onclick="saveStudy2Notes(${index})">Save</button>
                        <button class="btn-secondary" onclick="hideStudy2NotesForm(${index})">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        list.appendChild(div);
    });

    updateStudy2Stats();
}

function updateStudy2Stats() {
    const completed = study2Items.filter(t => t.completed).length;
    const total = study2Items.length;
    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
    document.getElementById('study2CompletedCount').textContent = completed;
    document.getElementById('study2RemainingCount').textContent = total - completed;
    document.getElementById('study2ProgressPercent').textContent = percent + '%';
    document.getElementById('study2ProgressBar').style.width = percent + '%';
}

function saveStudy2() {
    localStorage.setItem('phdStudy2', JSON.stringify(study2Items));
    renderCalendar();
}

function toggleStudy2(index) {
    const wasCompleted = study2Items[index].completed;
    study2Items[index].completed = !wasCompleted;
    if (wasCompleted && !study2Items[index].completed) {
        study2Items[index].priority = 'medium';
    }
    saveStudy2();
    renderStudy2();
}

function toggleStudy2PriorityMenu(index, event) {
    event.stopPropagation();
    if (study2Items[index].completed) return;
    const menu = document.getElementById(`study2-priority-menu-${index}`);
    document.querySelectorAll('.priority-menu').forEach(m => {
        if (m !== menu) m.classList.remove('active');
    });
    menu.classList.toggle('active');
}

function setStudy2Priority(index, priority) {
    study2Items[index].priority = priority;
    saveStudy2();
    renderStudy2();
}

function showStudy2SubtaskForm(index) {
    document.querySelectorAll('.subtask-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`study2-subtask-form-${index}`).classList.add('active');
    document.getElementById(`study2-subtask-input-${index}`).focus();
}

function hideStudy2SubtaskForm(index) {
    document.getElementById(`study2-subtask-form-${index}`).classList.remove('active');
    document.getElementById(`study2-subtask-input-${index}`).value = '';
}

function saveStudy2Subtask(index) {
    const text = document.getElementById(`study2-subtask-input-${index}`).value.trim();
    if (!text) { alert('Please enter a subtask'); return; }
    if (!study2Items[index].subtasks) study2Items[index].subtasks = [];
    study2Items[index].subtasks.push({ text: text, completed: false });
    saveStudy2();
    renderStudy2();
}

function toggleStudy2Subtask(itemIndex, subtaskIndex) {
    study2Items[itemIndex].subtasks[subtaskIndex].completed = !study2Items[itemIndex].subtasks[subtaskIndex].completed;
    saveStudy2();
    renderStudy2();
}

function removeStudy2Subtask(itemIndex, subtaskIndex) {
    if (confirm('Remove this subtask?')) {
        study2Items[itemIndex].subtasks.splice(subtaskIndex, 1);
        saveStudy2();
        renderStudy2();
    }
}

function showStudy2AttachmentForm(index) {
    document.querySelectorAll('.attachment-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`study2-attachment-form-${index}`).classList.add('active');
}

function hideStudy2AttachmentForm(index) {
    document.getElementById(`study2-attachment-form-${index}`).classList.remove('active');
    document.getElementById(`study2-attachment-name-${index}`).value = '';
    document.getElementById(`study2-attachment-url-${index}`).value = '';
}

function saveStudy2Attachment(index) {
    const name = document.getElementById(`study2-attachment-name-${index}`).value.trim();
    const url = document.getElementById(`study2-attachment-url-${index}`).value.trim();
    if (!name || !url) { alert('Please fill in both fields'); return; }
    if (!study2Items[index].attachments) study2Items[index].attachments = [];
    study2Items[index].attachments.push({ name, url });
    saveStudy2();
    renderStudy2();
}

function removeStudy2Attachment(itemIndex, attachmentIndex) {
    if (confirm('Remove this attachment?')) {
        study2Items[itemIndex].attachments.splice(attachmentIndex, 1);
        saveStudy2();
        renderStudy2();
    }
}

function showStudy2NotesForm(index) {
    document.getElementById(`study2-notes-form-${index}`).classList.add('active');
}

function hideStudy2NotesForm(index) {
    document.getElementById(`study2-notes-form-${index}`).classList.remove('active');
}

function saveStudy2Notes(index) {
    const notes = document.getElementById(`study2-notes-textarea-${index}`).value.trim();
    study2Items[index].notes = notes;
    saveStudy2();
    renderStudy2();
}

let editingStudy2Index = null;

function openStudy2Modal() {
    document.getElementById('study2Title').value = '';
    document.getElementById('study2Date').value = '';
    document.getElementById('study2Desc').value = '';
    document.getElementById('study2Priority').value = 'medium';
    document.getElementById('study2Modal').classList.add('active');
}

function closeStudy2Modal() {
    document.getElementById('study2Modal').classList.remove('active');
    document.querySelector('#study2Modal h2').textContent = 'Add Study 2 Item';
    document.querySelector('#study2Modal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#study2Modal .modal-buttons button:last-child').onclick = addStudy2;
    document.getElementById('study2DeleteBtn').style.display = 'none';
    editingStudy2Index = null;
}

function closeStudy2ModalOnOutside(event) {
    if (event.target.id === 'study2Modal') closeStudy2Modal();
}

function addStudy2() {
    const title = document.getElementById('study2Title').value.trim();
    const date = document.getElementById('study2Date').value;
    const description = document.getElementById('study2Desc').value.trim();
    const priority = document.getElementById('study2Priority').value;
    if (!title) { alert('Please fill in a title'); return; }
    study2Items.push({
        title, date: date || null, description,
        completed: false, attachments: [], notes: "", subtasks: [], priority
    });
    saveStudy2();
    renderStudy2();
    closeStudy2Modal();
}

function openEditStudy2Modal(index) {
    editingStudy2Index = index;
    const item = study2Items[index];
    document.getElementById('study2Title').value = item.title;
    document.getElementById('study2Date').value = item.date || '';
    document.getElementById('study2Desc').value = item.description || '';
    document.getElementById('study2Priority').value = item.priority || 'medium';
    document.querySelector('#study2Modal h2').textContent = 'Edit Study 2 Item';
    document.querySelector('#study2Modal .modal-buttons button:last-child').textContent = 'Update';
    document.querySelector('#study2Modal .modal-buttons button:last-child').onclick = updateStudy2;
    document.getElementById('study2DeleteBtn').style.display = 'block';
    document.getElementById('study2Modal').classList.add('active');
}

function updateStudy2() {
    const title = document.getElementById('study2Title').value.trim();
    const date = document.getElementById('study2Date').value;
    const description = document.getElementById('study2Desc').value.trim();
    const priority = document.getElementById('study2Priority').value;
    if (!title) { alert('Please fill in a title'); return; }
    study2Items[editingStudy2Index].title = title;
    study2Items[editingStudy2Index].date = date || null;
    study2Items[editingStudy2Index].description = description;
    study2Items[editingStudy2Index].priority = priority;
    saveStudy2();
    renderStudy2();
    closeStudy2Modal();
    document.querySelector('#study2Modal h2').textContent = 'Add Study 2 Item';
    document.querySelector('#study2Modal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#study2Modal .modal-buttons button:last-child').onclick = addStudy2;
    editingStudy2Index = null;
}

function deleteStudy2FromModal() {
    if (confirm('Are you sure you want to delete this item? This cannot be undone.')) {
        study2Items.splice(editingStudy2Index, 1);
        saveStudy2();
        renderStudy2();
        closeStudy2Modal();
    }
}

function goToStudy2(index) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab')[4].classList.add('active');
    document.getElementById('study2').classList.add('active');
    setTimeout(() => {
        const elements = document.querySelectorAll('#study2List .milestone');
        const sorted = [...study2Items].sort((a, b) => {
            if (a.completed !== b.completed) return a.completed ? 1 : -1;
            if (!a.date && b.date) return 1;
            if (a.date && !b.date) return -1;
            if (!a.date && !b.date) return 0;
            return new Date(a.date) - new Date(b.date);
        });
        const target = study2Items[index];
        const sortedIndex = sorted.indexOf(target);
        if (elements[sortedIndex]) {
            elements[sortedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            elements[sortedIndex].style.backgroundColor = '#fff9c4';
            setTimeout(() => { elements[sortedIndex].style.backgroundColor = ''; }, 1500);
        }
    }, 100);
}

// ========== Study 3 Functions ==========
function renderStudy3() {
    const list = document.getElementById('study3List');
    list.innerHTML = '';
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const sortedStudy3 = [...study3Items].sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        if (!a.date && b.date) return 1;
        if (a.date && !b.date) return -1;
        if (!a.date && !b.date) return 0;
        return new Date(a.date) - new Date(b.date);
    });

    sortedStudy3.forEach((item) => {
        const index = study3Items.indexOf(item);
        const dueDate = item.date ? new Date(item.date) : null;
        const isOverdue = !item.completed && dueDate && dueDate < today;
        
        if (!item.attachments) item.attachments = [];
        if (!item.notes) item.notes = "";
        if (!item.subtasks) item.subtasks = [];
        if (!item.priority) item.priority = "medium";
        
        const div = document.createElement('div');
        div.className = 'milestone' + (item.completed ? ' completed' : '');
        div.innerHTML = `
            <div class="milestone-header">
                <input type="checkbox" class="checkbox" ${item.completed ? 'checked' : ''} 
                       onchange="toggleStudy3(${index})">
                <div style="flex: 1;">
                    <div class="milestone-title">${item.title}</div>
                    ${item.date ? `<div class="milestone-date ${isOverdue ? 'overdue' : ''}">
                        ${formatDate(item.date)} ${isOverdue ? '(overdue)' : ''}
                    </div>` : '<div class="milestone-date" style="color: #999;">No due date</div>'}
                </div>
                <div class="priority-indicator">
                    <div class="priority-dot ${item.completed ? 'done' : (item.priority || 'medium')}" 
                         onclick="toggleStudy3PriorityMenu(${index}, event)" 
                         title="${item.completed ? 'Done' : ((item.priority || 'medium').charAt(0).toUpperCase() + (item.priority || 'medium').slice(1) + ' priority')}">
                    </div>
                    <div class="priority-menu" id="study3-priority-menu-${index}">
                        <div class="priority-option" onclick="setStudy3Priority(${index}, 'high')">
                            <div class="priority-option-dot high"></div>
                            <span>High</span>
                        </div>
                        <div class="priority-option" onclick="setStudy3Priority(${index}, 'medium')">
                            <div class="priority-option-dot medium"></div>
                            <span>Medium</span>
                        </div>
                        <div class="priority-option" onclick="setStudy3Priority(${index}, 'low')">
                            <div class="priority-option-dot low"></div>
                            <span>Low</span>
                        </div>
                    </div>
                </div>
                <button class="edit-milestone-btn" onclick="openEditStudy3Modal(${index})">Edit</button>
            </div>
            ${item.description ? `<div class="milestone-description">${item.description}</div>` : ''}
            
            ${item.subtasks.length > 0 ? `
                <div class="subtasks-section">
                    ${item.subtasks.map((subtask, subIndex) => `
                        <div class="subtask-item">
                            <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                   onchange="toggleStudy3Subtask(${index}, ${subIndex})">
                                    <span class="subtask-text ${subtask.completed ? 'completed' : ''}" 
                                          contenteditable="true" 
                                          onblur="updateStudy3SubtaskText(${index}, ${subIndex}, this.textContent)"
                                          onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${subtask.text}</span>
                            <span class="remove-subtask" onclick="removeStudy3Subtask(${index}, ${subIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-subtask-btn" onclick="showStudy3SubtaskForm(${index})">+ Add Subtask</button>
            <div class="subtask-form" id="study3-subtask-form-${index}">
                <input type="text" id="study3-subtask-input-${index}" placeholder="Enter subtask...">
                <button onclick="saveStudy3Subtask(${index})">Add</button>
                <button class="btn-secondary" onclick="hideStudy3SubtaskForm(${index})">Cancel</button>
            </div>

            ${item.attachments.length > 0 ? `
                <div class="attachments">
                    ${item.attachments.map((att, attIndex) => `
                        <div class="attachment-item">
                            <a href="${att.url}" target="_blank" class="attachment-link" title="${att.url}">
                                üìé ${att.name}
                            </a>
                            <span class="remove-attachment" onclick="removeStudy3Attachment(${index}, ${attIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-attachment-btn" onclick="showStudy3AttachmentForm(${index})">+ Add Link</button>
            <div class="attachment-form" id="study3-attachment-form-${index}">
                <input type="text" id="study3-attachment-name-${index}" placeholder="Link name">
                <input type="text" id="study3-attachment-url-${index}" placeholder="Web link OR file path">
                <div class="attachment-form-buttons">
                    <button onclick="saveStudy3Attachment(${index})">Save</button>
                    <button class="btn-secondary" onclick="hideStudy3AttachmentForm(${index})">Cancel</button>
                </div>
            </div>

            <div class="milestone-notes">
                ${item.notes ? `<div class="notes-display">${item.notes}</div>` : ''}
                <button class="add-notes-btn" onclick="showStudy3NotesForm(${index})">${item.notes ? 'Edit Notes' : '+ Add Notes'}</button>
                <div class="notes-form" id="study3-notes-form-${index}">
                    <textarea id="study3-notes-textarea-${index}" placeholder="Add notes...">${item.notes || ''}</textarea>
                    <div class="notes-buttons">
                        <button onclick="saveStudy3Notes(${index})">Save</button>
                        <button class="btn-secondary" onclick="hideStudy3NotesForm(${index})">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        list.appendChild(div);
    });

    updateStudy3Stats();
}

function updateStudy3Stats() {
    const completed = study3Items.filter(t => t.completed).length;
    const total = study3Items.length;
    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
    document.getElementById('study3CompletedCount').textContent = completed;
    document.getElementById('study3RemainingCount').textContent = total - completed;
    document.getElementById('study3ProgressPercent').textContent = percent + '%';
    document.getElementById('study3ProgressBar').style.width = percent + '%';
}

function saveStudy3() {
    localStorage.setItem('phdStudy3', JSON.stringify(study3Items));
    renderCalendar();
}

function toggleStudy3(index) {
    const wasCompleted = study3Items[index].completed;
    study3Items[index].completed = !wasCompleted;
    if (wasCompleted && !study3Items[index].completed) {
        study3Items[index].priority = 'medium';
    }
    saveStudy3();
    renderStudy3();
}

function toggleStudy3PriorityMenu(index, event) {
    event.stopPropagation();
    if (study3Items[index].completed) return;
    const menu = document.getElementById(`study3-priority-menu-${index}`);
    document.querySelectorAll('.priority-menu').forEach(m => {
        if (m !== menu) m.classList.remove('active');
    });
    menu.classList.toggle('active');
}

function setStudy3Priority(index, priority) {
    study3Items[index].priority = priority;
    saveStudy3();
    renderStudy3();
}

function showStudy3SubtaskForm(index) {
    document.querySelectorAll('.subtask-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`study3-subtask-form-${index}`).classList.add('active');
    document.getElementById(`study3-subtask-input-${index}`).focus();
}

function hideStudy3SubtaskForm(index) {
    document.getElementById(`study3-subtask-form-${index}`).classList.remove('active');
    document.getElementById(`study3-subtask-input-${index}`).value = '';
}

function saveStudy3Subtask(index) {
    const text = document.getElementById(`study3-subtask-input-${index}`).value.trim();
    if (!text) { alert('Please enter a subtask'); return; }
    if (!study3Items[index].subtasks) study3Items[index].subtasks = [];
    study3Items[index].subtasks.push({ text: text, completed: false });
    saveStudy3();
    renderStudy3();
}

function toggleStudy3Subtask(itemIndex, subtaskIndex) {
    study3Items[itemIndex].subtasks[subtaskIndex].completed = !study3Items[itemIndex].subtasks[subtaskIndex].completed;
    saveStudy3();
    renderStudy3();
}

function removeStudy3Subtask(itemIndex, subtaskIndex) {
    if (confirm('Remove this subtask?')) {
        study3Items[itemIndex].subtasks.splice(subtaskIndex, 1);
        saveStudy3();
        renderStudy3();
    }
}

function showStudy3AttachmentForm(index) {
    document.querySelectorAll('.attachment-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`study3-attachment-form-${index}`).classList.add('active');
}

function hideStudy3AttachmentForm(index) {
    document.getElementById(`study3-attachment-form-${index}`).classList.remove('active');
    document.getElementById(`study3-attachment-name-${index}`).value = '';
    document.getElementById(`study3-attachment-url-${index}`).value = '';
}

function saveStudy3Attachment(index) {
    const name = document.getElementById(`study3-attachment-name-${index}`).value.trim();
    const url = document.getElementById(`study3-attachment-url-${index}`).value.trim();
    if (!name || !url) { alert('Please fill in both fields'); return; }
    if (!study3Items[index].attachments) study3Items[index].attachments = [];
    study3Items[index].attachments.push({ name, url });
    saveStudy3();
    renderStudy3();
}

function removeStudy3Attachment(itemIndex, attachmentIndex) {
    if (confirm('Remove this attachment?')) {
        study3Items[itemIndex].attachments.splice(attachmentIndex, 1);
        saveStudy3();
        renderStudy3();
    }
}

function showStudy3NotesForm(index) {
    document.getElementById(`study3-notes-form-${index}`).classList.add('active');
}

function hideStudy3NotesForm(index) {
    document.getElementById(`study3-notes-form-${index}`).classList.remove('active');
}

function saveStudy3Notes(index) {
    const notes = document.getElementById(`study3-notes-textarea-${index}`).value.trim();
    study3Items[index].notes = notes;
    saveStudy3();
    renderStudy3();
}

let editingStudy3Index = null;

function openStudy3Modal() {
    document.getElementById('study3Title').value = '';
    document.getElementById('study3Date').value = '';
    document.getElementById('study3Desc').value = '';
    document.getElementById('study3Priority').value = 'medium';
    document.getElementById('study3Modal').classList.add('active');
}

function closeStudy3Modal() {
    document.getElementById('study3Modal').classList.remove('active');
    document.querySelector('#study3Modal h2').textContent = 'Add Study 3 Item';
    document.querySelector('#study3Modal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#study3Modal .modal-buttons button:last-child').onclick = addStudy3;
    document.getElementById('study3DeleteBtn').style.display = 'none';
    editingStudy3Index = null;
}

function closeStudy3ModalOnOutside(event) {
    if (event.target.id === 'study3Modal') closeStudy3Modal();
}

function addStudy3() {
    const title = document.getElementById('study3Title').value.trim();
    const date = document.getElementById('study3Date').value;
    const description = document.getElementById('study3Desc').value.trim();
    const priority = document.getElementById('study3Priority').value;
    if (!title) { alert('Please fill in a title'); return; }
    study3Items.push({
        title, date: date || null, description,
        completed: false, attachments: [], notes: "", subtasks: [], priority
    });
    saveStudy3();
    renderStudy3();
    closeStudy3Modal();
}

function openEditStudy3Modal(index) {
    editingStudy3Index = index;
    const item = study3Items[index];
    document.getElementById('study3Title').value = item.title;
    document.getElementById('study3Date').value = item.date || '';
    document.getElementById('study3Desc').value = item.description || '';
    document.getElementById('study3Priority').value = item.priority || 'medium';
    document.querySelector('#study3Modal h2').textContent = 'Edit Study 3 Item';
    document.querySelector('#study3Modal .modal-buttons button:last-child').textContent = 'Update';
    document.querySelector('#study3Modal .modal-buttons button:last-child').onclick = updateStudy3;
    document.getElementById('study3DeleteBtn').style.display = 'block';
    document.getElementById('study3Modal').classList.add('active');
}

function updateStudy3() {
    const title = document.getElementById('study3Title').value.trim();
    const date = document.getElementById('study3Date').value;
    const description = document.getElementById('study3Desc').value.trim();
    const priority = document.getElementById('study3Priority').value;
    if (!title) { alert('Please fill in a title'); return; }
    study3Items[editingStudy3Index].title = title;
    study3Items[editingStudy3Index].date = date || null;
    study3Items[editingStudy3Index].description = description;
    study3Items[editingStudy3Index].priority = priority;
    saveStudy3();
    renderStudy3();
    closeStudy3Modal();
    document.querySelector('#study3Modal h2').textContent = 'Add Study 3 Item';
    document.querySelector('#study3Modal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#study3Modal .modal-buttons button:last-child').onclick = addStudy3;
    editingStudy3Index = null;
}

function deleteStudy3FromModal() {
    if (confirm('Are you sure you want to delete this item? This cannot be undone.')) {
        study3Items.splice(editingStudy3Index, 1);
        saveStudy3();
        renderStudy3();
        closeStudy3Modal();
    }
}

function goToStudy3(index) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab')[5].classList.add('active');
    document.getElementById('study3').classList.add('active');
    setTimeout(() => {
        const elements = document.querySelectorAll('#study3List .milestone');
        const sorted = [...study3Items].sort((a, b) => {
            if (a.completed !== b.completed) return a.completed ? 1 : -1;
            if (!a.date && b.date) return 1;
            if (a.date && !b.date) return -1;
            if (!a.date && !b.date) return 0;
            return new Date(a.date) - new Date(b.date);
        });
        const target = study3Items[index];
        const sortedIndex = sorted.indexOf(target);
        if (elements[sortedIndex]) {
            elements[sortedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            elements[sortedIndex].style.backgroundColor = '#fff9c4';
            setTimeout(() => { elements[sortedIndex].style.backgroundColor = ''; }, 1500);
        }
    }, 100);
}

// ========== Other Chapters Functions ==========
function renderOtherChapters() {
    const list = document.getElementById('otherchaptersList');
    list.innerHTML = '';
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const sortedOtherChapters = [...otherChaptersItems].sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        if (!a.date && b.date) return 1;
        if (a.date && !b.date) return -1;
        if (!a.date && !b.date) return 0;
        return new Date(a.date) - new Date(b.date);
    });

    sortedOtherChapters.forEach((item) => {
        const index = otherChaptersItems.indexOf(item);
        const dueDate = item.date ? new Date(item.date) : null;
        const isOverdue = !item.completed && dueDate && dueDate < today;
        
        if (!item.attachments) item.attachments = [];
        if (!item.notes) item.notes = "";
        if (!item.subtasks) item.subtasks = [];
        if (!item.priority) item.priority = "medium";
        
        const div = document.createElement('div');
        div.className = 'milestone' + (item.completed ? ' completed' : '');
        div.innerHTML = `
            <div class="milestone-header">
                <input type="checkbox" class="checkbox" ${item.completed ? 'checked' : ''} 
                       onchange="toggleOtherChapters(${index})">
                <div style="flex: 1;">
                    <div class="milestone-title">${item.title}</div>
                    ${item.date ? `<div class="milestone-date ${isOverdue ? 'overdue' : ''}">
                        ${formatDate(item.date)} ${isOverdue ? '(overdue)' : ''}
                    </div>` : '<div class="milestone-date" style="color: #999;">No due date</div>'}
                </div>
                <div class="priority-indicator">
                    <div class="priority-dot ${item.completed ? 'done' : (item.priority || 'medium')}" 
                         onclick="toggleOtherChaptersPriorityMenu(${index}, event)" 
                         title="${item.completed ? 'Done' : ((item.priority || 'medium').charAt(0).toUpperCase() + (item.priority || 'medium').slice(1) + ' priority')}">
                    </div>
                    <div class="priority-menu" id="otherchapters-priority-menu-${index}">
                        <div class="priority-option" onclick="setOtherChaptersPriority(${index}, 'high')">
                            <div class="priority-option-dot high"></div>
                            <span>High</span>
                        </div>
                        <div class="priority-option" onclick="setOtherChaptersPriority(${index}, 'medium')">
                            <div class="priority-option-dot medium"></div>
                            <span>Medium</span>
                        </div>
                        <div class="priority-option" onclick="setOtherChaptersPriority(${index}, 'low')">
                            <div class="priority-option-dot low"></div>
                            <span>Low</span>
                        </div>
                    </div>
                </div>
                <button class="edit-milestone-btn" onclick="openEditOtherChaptersModal(${index})">Edit</button>
            </div>
            ${item.description ? `<div class="milestone-description">${item.description}</div>` : ''}
            
            ${item.subtasks.length > 0 ? `
                <div class="subtasks-section">
                    ${item.subtasks.map((subtask, subIndex) => `
                        <div class="subtask-item">
                            <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                   onchange="toggleOtherChaptersSubtask(${index}, ${subIndex})">
                                    <span class="subtask-text ${subtask.completed ? 'completed' : ''}" 
                                          contenteditable="true" 
                                          onblur="updateOtherChaptersSubtaskText(${index}, ${subIndex}, this.textContent)"
                                          onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${subtask.text}</span>
                            <span class="remove-subtask" onclick="removeOtherChaptersSubtask(${index}, ${subIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-subtask-btn" onclick="showOtherChaptersSubtaskForm(${index})">+ Add Subtask</button>
            <div class="subtask-form" id="otherchapters-subtask-form-${index}">
                <input type="text" id="otherchapters-subtask-input-${index}" placeholder="Enter subtask...">
                <button onclick="saveOtherChaptersSubtask(${index})">Add</button>
                <button class="btn-secondary" onclick="hideOtherChaptersSubtaskForm(${index})">Cancel</button>
            </div>

            ${item.attachments.length > 0 ? `
                <div class="attachments">
                    ${item.attachments.map((att, attIndex) => `
                        <div class="attachment-item">
                            <a href="${att.url}" target="_blank" class="attachment-link" title="${att.url}">
                                üìé ${att.name}
                            </a>
                            <span class="remove-attachment" onclick="removeOtherChaptersAttachment(${index}, ${attIndex})">‚úï</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            <button class="add-attachment-btn" onclick="showOtherChaptersAttachmentForm(${index})">+ Add Link</button>
            <div class="attachment-form" id="otherchapters-attachment-form-${index}">
                <input type="text" id="otherchapters-attachment-name-${index}" placeholder="Link name">
                <input type="text" id="otherchapters-attachment-url-${index}" placeholder="Web link OR file path">
                <div class="attachment-form-buttons">
                    <button onclick="saveOtherChaptersAttachment(${index})">Save</button>
                    <button class="btn-secondary" onclick="hideOtherChaptersAttachmentForm(${index})">Cancel</button>
                </div>
            </div>

            <div class="milestone-notes">
                ${item.notes ? `<div class="notes-display">${item.notes}</div>` : ''}
                <button class="add-notes-btn" onclick="showOtherChaptersNotesForm(${index})">${item.notes ? 'Edit Notes' : '+ Add Notes'}</button>
                <div class="notes-form" id="otherchapters-notes-form-${index}">
                    <textarea id="otherchapters-notes-textarea-${index}" placeholder="Add notes...">${item.notes || ''}</textarea>
                    <div class="notes-buttons">
                        <button onclick="saveOtherChaptersNotes(${index})">Save</button>
                        <button class="btn-secondary" onclick="hideOtherChaptersNotesForm(${index})">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        list.appendChild(div);
    });

    updateOtherChaptersStats();
}

function updateOtherChaptersStats() {
    const completed = otherChaptersItems.filter(t => t.completed).length;
    const total = otherChaptersItems.length;
    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
    document.getElementById('otherchaptersCompletedCount').textContent = completed;
    document.getElementById('otherchaptersRemainingCount').textContent = total - completed;
    document.getElementById('otherchaptersProgressPercent').textContent = percent + '%';
    document.getElementById('otherchaptersProgressBar').style.width = percent + '%';
}

function saveOtherChapters() {
    localStorage.setItem('phdOtherChapters', JSON.stringify(otherChaptersItems));
    renderCalendar();
}

function toggleOtherChapters(index) {
    const wasCompleted = otherChaptersItems[index].completed;
    otherChaptersItems[index].completed = !wasCompleted;
    if (wasCompleted && !otherChaptersItems[index].completed) {
        otherChaptersItems[index].priority = 'medium';
    }
    saveOtherChapters();
    renderOtherChapters();
}

function toggleOtherChaptersPriorityMenu(index, event) {
    event.stopPropagation();
    if (otherChaptersItems[index].completed) return;
    const menu = document.getElementById(`otherchapters-priority-menu-${index}`);
    document.querySelectorAll('.priority-menu').forEach(m => {
        if (m !== menu) m.classList.remove('active');
    });
    menu.classList.toggle('active');
}

function setOtherChaptersPriority(index, priority) {
    otherChaptersItems[index].priority = priority;
    saveOtherChapters();
    renderOtherChapters();
}

function showOtherChaptersSubtaskForm(index) {
    document.querySelectorAll('.subtask-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`otherchapters-subtask-form-${index}`).classList.add('active');
    document.getElementById(`otherchapters-subtask-input-${index}`).focus();
}

function hideOtherChaptersSubtaskForm(index) {
    document.getElementById(`otherchapters-subtask-form-${index}`).classList.remove('active');
    document.getElementById(`otherchapters-subtask-input-${index}`).value = '';
}

function saveOtherChaptersSubtask(index) {
    const text = document.getElementById(`otherchapters-subtask-input-${index}`).value.trim();
    if (!text) { alert('Please enter a subtask'); return; }
    if (!otherChaptersItems[index].subtasks) otherChaptersItems[index].subtasks = [];
    otherChaptersItems[index].subtasks.push({ text: text, completed: false });
    saveOtherChapters();
    renderOtherChapters();
}

function toggleOtherChaptersSubtask(itemIndex, subtaskIndex) {
    otherChaptersItems[itemIndex].subtasks[subtaskIndex].completed = !otherChaptersItems[itemIndex].subtasks[subtaskIndex].completed;
    saveOtherChapters();
    renderOtherChapters();
}

function removeOtherChaptersSubtask(itemIndex, subtaskIndex) {
    if (confirm('Remove this subtask?')) {
        otherChaptersItems[itemIndex].subtasks.splice(subtaskIndex, 1);
        saveOtherChapters();
        renderOtherChapters();
    }
}

function showOtherChaptersAttachmentForm(index) {
    document.querySelectorAll('.attachment-form').forEach(form => form.classList.remove('active'));
    document.getElementById(`otherchapters-attachment-form-${index}`).classList.add('active');
}

function hideOtherChaptersAttachmentForm(index) {
    document.getElementById(`otherchapters-attachment-form-${index}`).classList.remove('active');
    document.getElementById(`otherchapters-attachment-name-${index}`).value = '';
    document.getElementById(`otherchapters-attachment-url-${index}`).value = '';
}

function saveOtherChaptersAttachment(index) {
    const name = document.getElementById(`otherchapters-attachment-name-${index}`).value.trim();
    const url = document.getElementById(`otherchapters-attachment-url-${index}`).value.trim();
    if (!name || !url) { alert('Please fill in both fields'); return; }
    if (!otherChaptersItems[index].attachments) otherChaptersItems[index].attachments = [];
    otherChaptersItems[index].attachments.push({ name, url });
    saveOtherChapters();
    renderOtherChapters();
}

function removeOtherChaptersAttachment(itemIndex, attachmentIndex) {
    if (confirm('Remove this attachment?')) {
        otherChaptersItems[itemIndex].attachments.splice(attachmentIndex, 1);
        saveOtherChapters();
        renderOtherChapters();
    }
}

function showOtherChaptersNotesForm(index) {
    document.getElementById(`otherchapters-notes-form-${index}`).classList.add('active');
}

function hideOtherChaptersNotesForm(index) {
    document.getElementById(`otherchapters-notes-form-${index}`).classList.remove('active');
}

function saveOtherChaptersNotes(index) {
    const notes = document.getElementById(`otherchapters-notes-textarea-${index}`).value.trim();
    otherChaptersItems[index].notes = notes;
    saveOtherChapters();
    renderOtherChapters();
}

let editingOtherChaptersIndex = null;

function openOtherChaptersModal() {
    document.getElementById('otherchaptersTitle').value = '';
    document.getElementById('otherchaptersDate').value = '';
    document.getElementById('otherchaptersDesc').value = '';
    document.getElementById('otherchaptersPriority').value = 'medium';
    document.getElementById('otherchaptersModal').classList.add('active');
}

function closeOtherChaptersModal() {
    document.getElementById('otherchaptersModal').classList.remove('active');
    document.querySelector('#otherchaptersModal h2').textContent = 'Add Other Chapters Item';
    document.querySelector('#otherchaptersModal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#otherchaptersModal .modal-buttons button:last-child').onclick = addOtherChapters;
    document.getElementById('otherchaptersDeleteBtn').style.display = 'none';
    editingOtherChaptersIndex = null;
}

function closeOtherChaptersModalOnOutside(event) {
    if (event.target.id === 'otherchaptersModal') closeOtherChaptersModal();
}

function addOtherChapters() {
    const title = document.getElementById('otherchaptersTitle').value.trim();
    const date = document.getElementById('otherchaptersDate').value;
    const description = document.getElementById('otherchaptersDesc').value.trim();
    const priority = document.getElementById('otherchaptersPriority').value;
    if (!title) { alert('Please fill in a title'); return; }
    otherChaptersItems.push({
        title, date: date || null, description,
        completed: false, attachments: [], notes: "", subtasks: [], priority
    });
    saveOtherChapters();
    renderOtherChapters();
    closeOtherChaptersModal();
}

function openEditOtherChaptersModal(index) {
    editingOtherChaptersIndex = index;
    const item = otherChaptersItems[index];
    document.getElementById('otherchaptersTitle').value = item.title;
    document.getElementById('otherchaptersDate').value = item.date || '';
    document.getElementById('otherchaptersDesc').value = item.description || '';
    document.getElementById('otherchaptersPriority').value = item.priority || 'medium';
    document.querySelector('#otherchaptersModal h2').textContent = 'Edit Other Chapters Item';
    document.querySelector('#otherchaptersModal .modal-buttons button:last-child').textContent = 'Update';
    document.querySelector('#otherchaptersModal .modal-buttons button:last-child').onclick = updateOtherChapters;
    document.getElementById('otherchaptersDeleteBtn').style.display = 'block';
    document.getElementById('otherchaptersModal').classList.add('active');
}

function updateOtherChapters() {
    const title = document.getElementById('otherchaptersTitle').value.trim();
    const date = document.getElementById('otherchaptersDate').value;
    const description = document.getElementById('otherchaptersDesc').value.trim();
    const priority = document.getElementById('otherchaptersPriority').value;
    if (!title) { alert('Please fill in a title'); return; }
    otherChaptersItems[editingOtherChaptersIndex].title = title;
    otherChaptersItems[editingOtherChaptersIndex].date = date || null;
    otherChaptersItems[editingOtherChaptersIndex].description = description;
    otherChaptersItems[editingOtherChaptersIndex].priority = priority;
    saveOtherChapters();
    renderOtherChapters();
    closeOtherChaptersModal();
    document.querySelector('#otherchaptersModal h2').textContent = 'Add Other Chapters Item';
    document.querySelector('#otherchaptersModal .modal-buttons button:last-child').textContent = 'Add';
    document.querySelector('#otherchaptersModal .modal-buttons button:last-child').onclick = addOtherChapters;
    editingOtherChaptersIndex = null;
}

function deleteOtherChaptersFromModal() {
    if (confirm('Are you sure you want to delete this item? This cannot be undone.')) {
        otherChaptersItems.splice(editingOtherChaptersIndex, 1);
        saveOtherChapters();
        renderOtherChapters();
        closeOtherChaptersModal();
    }
}

function goToOtherChapters(index) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab')[6].classList.add('active');
    document.getElementById('otherchapters').classList.add('active');
    setTimeout(() => {
        const elements = document.querySelectorAll('#otherchaptersList .milestone');
        const sorted = [...otherChaptersItems].sort((a, b) => {
            if (a.completed !== b.completed) return a.completed ? 1 : -1;
            if (!a.date && b.date) return 1;
            if (a.date && !b.date) return -1;
            if (!a.date && !b.date) return 0;
            return new Date(a.date) - new Date(b.date);
        });
        const target = otherChaptersItems[index];
        const sortedIndex = sorted.indexOf(target);
        if (elements[sortedIndex]) {
            elements[sortedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            elements[sortedIndex].style.backgroundColor = '#fff9c4';
            setTimeout(() => { elements[sortedIndex].style.backgroundColor = ''; }, 1500);
        }
    }, 100);
}


        function updateTodo() {
            const title = document.getElementById('todoTitle').value.trim();
            const date = document.getElementById('todoDate').value;
            const description = document.getElementById('todoDesc').value.trim();
            const priority = document.getElementById('todoPriority').value;

            if (!title) {
                alert('Please fill in a title');
                return;
            }

            todos[editingTodoIndex].title = title;
            todos[editingTodoIndex].date = date || null;
            todos[editingTodoIndex].description = description;
            todos[editingTodoIndex].priority = priority;

            saveTodos();
            renderTodos();
            closeTodoModal();
            
            document.querySelector('#todoModal h2').textContent = 'Add To Do';
            document.querySelector('#todoModal .modal-buttons button:last-child').textContent = 'Add';
            document.querySelector('#todoModal .modal-buttons button:last-child').onclick = addTodo;
            editingTodoIndex = null;
        }

        function renderCalendar() {
            const calendarView = document.getElementById('calendarView');
            const years = [2026, 2027, 2028, 2029];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Update summary stats at top of calendar
            document.getElementById('calendarCoCCount').textContent = milestones.filter(m => !m.completed).length;
            document.getElementById('calendarTodoCount').textContent = todos.filter(t => !t.completed).length;
            document.getElementById('calendarStudy1Count').textContent = study1Items.filter(s => !s.completed).length;
            document.getElementById('calendarStudy2Count').textContent = study2Items.filter(s => !s.completed).length;
            document.getElementById('calendarStudy3Count').textContent = study3Items.filter(s => !s.completed).length;
            document.getElementById('calendarOCCount').textContent = otherChaptersItems.filter(o => !o.completed).length;
            
            calendarView.innerHTML = '';
            
            // Combine all items for calendar display
            const allItems = [
                ...milestones.map(m => ({ ...m, type: 'milestone', label: 'M' })),
                ...todos.filter(t => t.date).map(t => ({ ...t, type: 'todo', label: 'T' })),
                ...study1Items.filter(t => t.date).map(t => ({ ...t, type: 'study1', label: 'S1' })),
                ...study2Items.filter(t => t.date).map(t => ({ ...t, type: 'study2', label: 'S2' })),
                ...study3Items.filter(t => t.date).map(t => ({ ...t, type: 'study3', label: 'S3' })),
                ...otherChaptersItems.filter(t => t.date).map(t => ({ ...t, type: 'otherchapters', label: 'OC' }))
            ];
            
            years.forEach(year => {
                // Count items for this year
                const yearItems = allItems.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate.getFullYear() === year;
                });
                
                const yearDiv = document.createElement('div');
                yearDiv.className = 'calendar-year';
                
                const isExpanded = year === 2026;
                
                const yearMilestoneCount = yearItems.filter(i => 
                    i.type === 'milestone' || 
                    i.type === 'study1' || 
                    i.type === 'study2' || 
                    i.type === 'study3' || 
                    i.type === 'otherchapters'
                ).length;
                const yearTodoCount = yearItems.filter(i => i.type === 'todo').length;
                
                const counts = [];
                if (yearMilestoneCount > 0) counts.push(`${yearMilestoneCount} milestone${yearMilestoneCount !== 1 ? 's' : ''}`);
                if (yearTodoCount > 0) counts.push(`${yearTodoCount} todo${yearTodoCount !== 1 ? 's' : ''}`);
                const countText = counts.length > 0 ? counts.join(', ') : 'No items';
                
                yearDiv.innerHTML = `
                    <div class="calendar-year-header" onclick="toggleYear(${year})">
                        <div class="calendar-year-title">${year}</div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="calendar-year-count">${countText}</div>
                            <div class="expand-icon ${isExpanded ? 'expanded' : ''}">‚ñº</div>
                        </div>
                    </div>
                    <div class="calendar-months ${isExpanded ? 'expanded' : ''}" id="year-${year}">
                        ${monthNames.map((monthName, monthIndex) => {
                            const monthItems = allItems.filter(item => {
                                const itemDate = new Date(item.date);
                                return itemDate.getFullYear() === year && itemDate.getMonth() === monthIndex;
                            });
                            
                            if (year === 2029 && monthIndex > 1) {
                                return '';
                            }
                            
                            return `
                                <div class="calendar-month">
                                    <div class="calendar-month-name">${monthName}</div>
                                    ${monthItems.length > 0 ? 
                                        monthItems.map(item => {
                                            const itemDate = new Date(item.date);
                                            const day = itemDate.getDate();
                                            const priorityClass = item.completed ? 'done' : (item.priority || 'medium');
                                            
                                            // Find index in original array
                                            let originalIndex = -1;
                                            let goToFunc = '';
                                            if (item.type === 'milestone') {
                                                originalIndex = milestones.findIndex(m => m === item || (m.title === item.title && m.date === item.date));
                                                goToFunc = 'goToMilestone';
                                            } else if (item.type === 'todo') {
                                                originalIndex = todos.findIndex(t => t === item || (t.title === item.title && t.date === item.date));
                                                goToFunc = 'goToTodo';
                                            } else if (item.type === 'study1') {
                                                originalIndex = study1Items.findIndex(t => t === item || (t.title === item.title && t.date === item.date));
                                                goToFunc = 'goToStudy1';
                                            } else if (item.type === 'study2') {
                                                originalIndex = study2Items.findIndex(t => t === item || (t.title === item.title && t.date === item.date));
                                                goToFunc = 'goToStudy2';
                                            } else if (item.type === 'study3') {
                                                originalIndex = study3Items.findIndex(t => t === item || (t.title === item.title && t.date === item.date));
                                                goToFunc = 'goToStudy3';
                                            } else if (item.type === 'otherchapters') {
                                                originalIndex = otherChaptersItems.findIndex(t => t === item || (t.title === item.title && t.date === item.date));
                                                goToFunc = 'goToOtherChapters';
                                            }
                                            
                                            const itemLabel = `[${item.label}]`;
                                            
                                            return `
                                                <div class="calendar-milestone-item" onclick="${goToFunc}(${originalIndex})" style="cursor: pointer;">
                                                    <div class="calendar-milestone-dot ${priorityClass}" style="background-color: ${
                                                        priorityClass === 'done' ? '#424242' :
                                                        priorityClass === 'high' ? '#d32f2f' :
                                                        priorityClass === 'medium' ? '#f57c00' :
                                                        '#7cb342'
                                                    }"></div>
                                                    <div class="calendar-milestone-text ${item.completed ? 'completed' : ''}" title="${item.title}" style="display: flex; gap: 6px;">
                                                        <span style="color: #999; font-weight: 600; flex-shrink: 0;">${itemLabel}</span>
                                                        <span style="overflow: hidden; text-overflow: ellipsis;">${item.title}</span>
                                                    </div>
                                                    <div class="calendar-milestone-date">${day}</div>
                                                </div>
                                            `;
                                        }).join('')
                                    : '<div class="no-milestones-calendar">No items</div>'}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                calendarView.appendChild(yearDiv);
            });
        }
        
        function toggleYear(year) {
            const monthsDiv = document.getElementById(`year-${year}`);
            const icon = event.currentTarget.querySelector('.expand-icon');
            
            monthsDiv.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        function goToMilestone(index) {
            // Switch to milestones tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelectorAll('.tab')[2].classList.add('active'); // Third tab is CoC Milestones
            document.getElementById('milestones').classList.add('active');
            
            // Scroll to the milestone and highlight it briefly
            setTimeout(() => {
                const milestoneElements = document.querySelectorAll('#milestoneList .milestone');
                const sortedMilestones = [...milestones].sort((a, b) => {
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1;
                    }
                    return new Date(a.date) - new Date(b.date);
                });
                
                const targetMilestone = milestones[index];
                const sortedIndex = sortedMilestones.indexOf(targetMilestone);
                
                if (milestoneElements[sortedIndex]) {
                    milestoneElements[sortedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    milestoneElements[sortedIndex].style.backgroundColor = '#fff9c4';
                    setTimeout(() => {
                        milestoneElements[sortedIndex].style.backgroundColor = '';
                    }, 1500);
                }
            }, 100);
        }

        function goToTodo(index) {
            // Switch to todos tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelectorAll('.tab')[1].classList.add('active'); // Second tab is To Do
            document.getElementById('todos').classList.add('active');
            
            // Scroll to the todo and highlight it briefly
            setTimeout(() => {
                const todoElements = document.querySelectorAll('#todoList .milestone');
                const sortedTodos = [...todos].sort((a, b) => {
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1;
                    }
                    if (!a.date && b.date) return 1;
                    if (a.date && !b.date) return -1;
                    if (!a.date && !b.date) return 0;
                    return new Date(a.date) - new Date(b.date);
                });
                
                const targetTodo = todos[index];
                const sortedIndex = sortedTodos.indexOf(targetTodo);
                
                if (todoElements[sortedIndex]) {
                    todoElements[sortedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    todoElements[sortedIndex].style.backgroundColor = '#fff9c4';
                    setTimeout(() => {
                        todoElements[sortedIndex].style.backgroundColor = '';
                    }, 1500);
                }
            }, 100);
        }
        // ========== Endorsement Functions ==========
        
        function renderEndorsement() {
            // Load settings
            const settings = JSON.parse(localStorage.getItem('endorsementSettings')) || {};
            document.getElementById('endorsementStartDate').value = settings.startDate || '';
            document.getElementById('endorsementSupervisor').value = settings.supervisor || '';
            document.getElementById('endorsementSupervisorContact').value = settings.supervisorContact || '';
            
            // Calculate end date (2 years from start)
            if (settings.startDate) {
                const start = new Date(settings.startDate);
                const end = new Date(start);
                end.setFullYear(end.getFullYear() + 2);
                document.getElementById('endorsementEndDate').value = end.toISOString().split('T')[0];
                
                // Calculate weeks completed
                const today = new Date();
                const weeksPassed = Math.floor((today - start) / (7 * 24 * 60 * 60 * 1000));
                const weeksCompleted = Math.min(weeksPassed, 104);
                document.getElementById('endorsementWeeksCompleted').textContent = weeksCompleted;
                document.getElementById('endorsementWeeksProgress').style.width = Math.min((weeksCompleted / 104) * 100, 100) + '%';
            }
            
            // Calculate supervision hours from log
            const supervisionLog = JSON.parse(localStorage.getItem('supervisionLog')) || [];
            const totalSupervisionHours = supervisionLog.reduce((sum, session) => sum + (parseFloat(session.hours) || 0), 0);
            document.getElementById('endorsementSupervisionHours').textContent = totalSupervisionHours.toFixed(1);
            document.getElementById('endorsementSupervisionProgress').style.width = Math.min((totalSupervisionHours / 80) * 100, 100) + '%';
            
            // Calculate active CPD hours from CPD tab
            const activeCPDHours = cpdEvents
                .filter(e => e.includedInCPD && e.type === 'active')
                .reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
            document.getElementById('endorsementActiveCPDHours').textContent = activeCPDHours.toFixed(1);
            document.getElementById('endorsementActiveCPDProgress').style.width = Math.min((activeCPDHours / 80) * 100, 100) + '%';
            
            // Render reference docs
            renderEndorsementDocs();
            
            // Render supervision log
            renderSupervisionLog();
            
            // Render progress reports
            renderProgressReports();
        }

        function saveEndorsementSettings() {
            const settings = {
                startDate: document.getElementById('endorsementStartDate').value,
                supervisor: document.getElementById('endorsementSupervisor').value,
                supervisorContact: document.getElementById('endorsementSupervisorContact').value
            };
            localStorage.setItem('endorsementSettings', JSON.stringify(settings));
            renderEndorsement();
        }

        function renderEndorsementDocs() {
            const list = document.getElementById('endorsementDocsList');
            const docs = JSON.parse(localStorage.getItem('endorsementDocs')) || [];
            
            if (docs.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 10px; color: #999; font-size: 13px; margin-bottom: 10px;">No documents yet. Add your key reference documents below.</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; align-items: end;">
                        <input type="text" id="newEndorsementDocName" placeholder="Document name" style="padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                        <input type="text" id="newEndorsementDocPath" placeholder="File path or URL" style="padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                        <button onclick="addEndorsementDocFromInputs()" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">Add Document</button>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = `
                ${docs.map((doc, index) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                        <a href="${doc.path}" target="_blank" style="color: #1976d2; text-decoration: none; font-size: 13px; flex: 1;">
                            üìÑ ${doc.name}
                        </a>
                        <button onclick="removeEndorsementDoc(${index})" style="padding: 4px 8px; background: white; color: #d32f2f; border: 1px solid #d32f2f; border-radius: 3px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                `).join('')}
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; align-items: end; margin-top: 10px;">
                    <input type="text" id="newEndorsementDocName" placeholder="Document name" style="padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <input type="text" id="newEndorsementDocPath" placeholder="File path or URL" style="padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <button onclick="addEndorsementDocFromInputs()" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">Add Document</button>
                </div>
            `;
        }

        function addEndorsementDocFromInputs() {
            const name = document.getElementById('newEndorsementDocName').value.trim();
            const path = document.getElementById('newEndorsementDocPath').value.trim();
            
            if (!name || !path) {
                alert('Please enter both document name and path/URL');
                return;
            }
            
            const docs = JSON.parse(localStorage.getItem('endorsementDocs')) || [];
            docs.push({ name, path });
            localStorage.setItem('endorsementDocs', JSON.stringify(docs));
            
            document.getElementById('newEndorsementDocName').value = '';
            document.getElementById('newEndorsementDocPath').value = '';
            
            renderEndorsementDocs();
        }

        function removeEndorsementDoc(index) {
            if (confirm('Remove this document?')) {
                const docs = JSON.parse(localStorage.getItem('endorsementDocs')) || [];
                docs.splice(index, 1);
                localStorage.setItem('endorsementDocs', JSON.stringify(docs));
                renderEndorsementDocs();
            }
        }

        // Supervision Log
        function renderSupervisionLog() {
            const list = document.getElementById('supervisionLogList');
            const log = JSON.parse(localStorage.getItem('supervisionLog')) || [];
            
            if (log.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No supervision sessions logged yet.</div>';
                return;
            }
            
            // Sort by date, most recent first
            log.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = log.map((session, index) => {
                // Find the actual index in the original array
                const originalLog = JSON.parse(localStorage.getItem('supervisionLog')) || [];
                const originalIndex = originalLog.findIndex(s => 
                    s.date === session.date && 
                    s.hours === session.hours && 
                    s.supervisor === session.supervisor
                );
                
                return `
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 600; color: #333;">${formatDate(session.date)} - ${session.hours}h</div>
                                <div style="font-size: 13px; color: #666; margin-top: 4px;">${session.type} with ${session.supervisor}</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editSupervisionSession(${originalIndex})" style="padding: 4px 10px; background: white; color: #2196f3; border: 1px solid #2196f3; border-radius: 4px; cursor: pointer; font-size: 12px;">Edit</button>
                                <button onclick="deleteSupervisionSession(${originalIndex})" style="padding: 4px 10px; background: white; color: #d32f2f; border: 1px solid #d32f2f; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                            </div>
                        </div>
                        ${session.content ? `<div style="font-size: 13px; color: #666; white-space: pre-wrap; margin-top: 8px; padding: 10px; background: #f9f9f9; border-radius: 4px;">${session.content}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        let editingSupervisionIndex = null;

        function openSupervisionModal() {
            editingSupervisionIndex = null;
            document.getElementById('supervisionDate').value = '';
            document.getElementById('supervisionHours').value = '';
            document.getElementById('supervisionType').value = 'Individual';
            document.getElementById('supervisionSupervisor').value = document.getElementById('endorsementSupervisor').value || '';
            document.getElementById('supervisionContent').value = '';
            document.querySelector('#supervisionModal h2').textContent = 'Add Supervision Session';
            document.querySelector('#supervisionModal .modal-buttons button:last-child').textContent = 'Add';
            document.getElementById('supervisionModal').classList.add('active');
        }

        function closeSupervisionModal() {
            document.getElementById('supervisionModal').classList.remove('active');
            editingSupervisionIndex = null;
        }

        function addSupervisionSession() {
            const date = document.getElementById('supervisionDate').value;
            const hours = document.getElementById('supervisionHours').value;
            const type = document.getElementById('supervisionType').value;
            const supervisor = document.getElementById('supervisionSupervisor').value;
            const content = document.getElementById('supervisionContent').value;
            
            if (!date || !hours || !supervisor) {
                alert('Please fill in date, hours, and supervisor');
                return;
            }
            
            const log = JSON.parse(localStorage.getItem('supervisionLog')) || [];
            
            if (editingSupervisionIndex !== null) {
                log[editingSupervisionIndex] = { date, hours: parseFloat(hours), type, supervisor, content };
            } else {
                log.push({ date, hours: parseFloat(hours), type, supervisor, content });
            }
            
            localStorage.setItem('supervisionLog', JSON.stringify(log));
            renderEndorsement();
            closeSupervisionModal();
        }

        function editSupervisionSession(index) {
            editingSupervisionIndex = index;
            const log = JSON.parse(localStorage.getItem('supervisionLog')) || [];
            const session = log[index];
            
            document.getElementById('supervisionDate').value = session.date;
            document.getElementById('supervisionHours').value = session.hours;
            document.getElementById('supervisionType').value = session.type;
            document.getElementById('supervisionSupervisor').value = session.supervisor;
            document.getElementById('supervisionContent').value = session.content || '';
            
            document.querySelector('#supervisionModal h2').textContent = 'Edit Supervision Session';
            document.querySelector('#supervisionModal .modal-buttons button:last-child').textContent = 'Update';
            document.getElementById('supervisionModal').classList.add('active');
        }

        function deleteSupervisionSession(index) {
            if (confirm('Delete this supervision session?')) {
                const log = JSON.parse(localStorage.getItem('supervisionLog')) || [];
                log.splice(index, 1);
                localStorage.setItem('supervisionLog', JSON.stringify(log));
                renderEndorsement();
            }
        }

        // Progress Reports
        function renderProgressReports() {
            const list = document.getElementById('progressReportsList');
            const reports = JSON.parse(localStorage.getItem('progressReports')) || [];
            const settings = JSON.parse(localStorage.getItem('endorsementSettings')) || {};
            
            // Generate 4 reports based on start date
            const reportSchedule = [];
            if (settings.startDate) {
                const start = new Date(settings.startDate);
                for (let i = 1; i <= 4; i++) {
                    const dueDate = new Date(start);
                    dueDate.setMonth(dueDate.getMonth() + (i * 6));
                    reportSchedule.push({
                        number: i,
                        dueDate: dueDate.toISOString().split('T')[0],
                        submitted: reports.find(r => r.number === i) || null
                    });
                }
            }
            
            if (reportSchedule.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Set your start date above to see progress report schedule.</div>';
                return;
            }
            
            list.innerHTML = reportSchedule.map(report => {
                const isPast = new Date(report.dueDate) < new Date();
                const status = report.submitted ? '‚úÖ Submitted' : (isPast ? '‚ö†Ô∏è Overdue' : '‚è≥ Upcoming');
                const statusColor = report.submitted ? '#4caf50' : (isPast ? '#f44336' : '#ff9800');
                
                return `
                    <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin-bottom: 10px; background: ${report.submitted ? '#f1f8f4' : 'white'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">Report ${report.number} - Due ${formatDate(report.dueDate)}</div>
                                <div style="font-size: 13px; color: ${statusColor}; margin-top: 4px;">${status}</div>
                                ${report.submitted ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">Submitted: ${formatDate(report.submitted.date)}</div>` : ''}
                            </div>
                            ${!report.submitted ? `
                                <button onclick="markReportSubmitted(${report.number})" style="padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Mark Submitted</button>
                            ` : `
                                <button onclick="unmarkReportSubmitted(${report.number})" style="padding: 6px 12px; background: white; color: #666; border: 1px solid #e0e0e0; border-radius: 4px; cursor: pointer; font-size: 13px;">Undo</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markReportSubmitted(number) {
            const reports = JSON.parse(localStorage.getItem('progressReports')) || [];
            reports.push({ number, date: new Date().toISOString().split('T')[0] });
            localStorage.setItem('progressReports', JSON.stringify(reports));
            renderProgressReports();
        }

        function unmarkReportSubmitted(number) {
            let reports = JSON.parse(localStorage.getItem('progressReports')) || [];
            reports = reports.filter(r => r.number !== number);
            localStorage.setItem('progressReports', JSON.stringify(reports));
            renderProgressReports();
        }

    </script>
    <!-- Supervision Session Modal -->
    <div id="supervisionModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>Add Supervision Session</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Date</label>
                <input type="date" id="supervisionDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Hours</label>
                <input type="number" id="supervisionHours" step="0.5" min="0" placeholder="e.g., 1.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Type</label>
                <select id="supervisionType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="Individual">Individual</option>
                    <option value="Group">Group</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Supervisor</label>
                <input type="text" id="supervisionSupervisor" placeholder="Supervisor name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Session Notes (optional)</label>
                <textarea id="supervisionContent" rows="6" placeholder="Brief record of discussion, supervisor's comments, plan for next session..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button onclick="closeSupervisionModal()" style="background: #e0e0e0; color: #333;">Cancel</button>
                <button onclick="addSupervisionSession()" style="background: #2196f3; color: white;">Add</button>
            </div>
        </div>
    </div>
        </div> <!-- Close mainContent -->
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://qkoeclfnwiowjpcuqrfj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_jHgBaBeWk1VCrH0GgPemkg_t8xAY05h';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Initialize Authentication on Page Load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAuth();
        });

        async function initializeAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                showMainContent(session.user.email);
            } else {
                showLoginScreen();
            }

            // Listen for auth changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (session) {
                    showMainContent(session.user.email);
                } else {
                    showLoginScreen();
                }
            });
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function showMainContent(userEmail) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('userEmail').textContent = userEmail;
        }

        async function loginWithGitHub() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    redirectTo: window.location.origin
                }
            });
            if (error) alert('Login failed: ' + error.message);
        }

        async function loginWithGoogle() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin
                }
            });
            if (error) alert('Login failed: ' + error.message);
        }

        async function loginWithMicrosoft() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'azure',
                options: {
                    redirectTo: window.location.origin
                }
            });
            if (error) alert('Login failed: ' + error.message);
        }

        async function logout() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                alert('Logout failed: ' + error.message);
            }
        }
    </script>

</body>
</html>
